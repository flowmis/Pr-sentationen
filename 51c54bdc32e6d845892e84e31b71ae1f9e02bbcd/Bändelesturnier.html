<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>TSV Ellwangen Volleyball: Bändeles-Turnier</title>
  <style>
    /* === GRUNDLAGEN === */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
    }
    h1, h2, h3, h4 {
      margin-top: 40px;
      color: #333;
    }
    .section {
      margin-bottom: 40px;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .button, .adjust-button {
      padding: 6px 12px;
      background-color: #28a745;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
      margin-left: 5px;
      transition: background-color 0.3s;
    }
    .button:hover, .adjust-button:hover {
      background-color: #218838;
    }
    .button:disabled, .adjust-button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    .export-button {
      background-color: #17a2b8;
    }
    .export-button:hover {
      background-color: #138496;
    }
    .message {
      margin-top: 10px;
      padding:10px;
      border-radius:5px;
    }
    .error {
      background-color: #f8d7da;
      color:#721c24;
    }
    .success {
      background-color:#d4edda;
      color:#155724;
    }

    /* PLAYER-LIST / TEAM-LIST */
    .player-list, .team-list, .matches-list {
      max-height:300px;
      overflow-y:auto;
      border:1px solid #aaa;
      padding:10px;
      margin-top:10px;
      background-color:#fff;
    }

    /* FARBKENNUNG */
    .adult-player {
      background-color:#ffe8e8; /* Rot */
    }
    .youth-player {
      background-color:#e8f7ff; /* Blau */
    }
    .adult-team {
      background-color:#ffe8e8;
      margin-bottom:5px;
      padding:5px;
      border-radius:4px;
    }
    .mixed-team {
      background-color:#e8f7ff;
      margin-bottom:5px;
      padding:5px;
      border-radius:4px;
    }

    /* TABELLEN */
    table {
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      background-color:#fff;
    }
    th, td {
      border:1px solid #aaa;
      padding:8px;
      text-align:left;
    }
    th {
      background-color:#4CAF50;
      color:white;
      cursor:pointer; /* Sortierung */
    }

    /* DETAILS-SPALTEN */
    .pos-col, .leist-col, .gesch-col {
      /* => per JS .style.display=none */
    }

    /* MODAL */
    .modal {
      display:none;
      position:fixed;
      z-index:999;
      padding-top:100px;
      left:0; top:0;
      width:100%;
      height:100%;
      overflow:auto;
      background-color:rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color:#fefefe;
      margin:auto;
      padding:20px;
      border:1px solid #888;
      width:80%;
      border-radius:8px;
    }
    .close {
      color:#aaa;
      float:right;
      font-size:24px;
      font-weight:bold;
      cursor:pointer;
      margin-bottom:10px;
    }
    .close:hover, .close:focus {
      color:black;
    }
  </style>
</head>
<body>

<h1>Volleyball Turnier Losgenerator</h1>

<label style="display:block; margin-bottom:20px;">
  <input type="checkbox" id="toggleDetails" />
  Details anzeigen
</label>

<!-- SPIELER HINZUFÜGEN -->
<div class="section">
  <h2>Spieler Hinzufügen</h2>
  <form id="addPlayerForm">
    <input type="text" id="playerName" placeholder="Name" required />
    <select id="playerType" required>
      <option value="" disabled selected>Erwachsen/Jugend</option>
      <option value="adult">Erwachsene/r</option>
      <option value="youth">Jugend</option>
    </select>
    <select id="playerPosition">
      <option value="" disabled selected>Position (nur Erw.)</option>
      <option value="MB">MB</option>
      <option value="AA">AA</option>
      <option value="Z">Z</option>
    </select>
    <select id="playerLeistung" required>
      <option value="" disabled selected>Leistung</option>
      <option value="1">1 - Sehr gut</option>
      <option value="2">2 - Gut</option>
      <option value="3">3 - Weniger gut</option>
    </select>
    <select id="playerGeschlecht" required>
      <option value="" disabled selected>Geschlecht</option>
      <option value="M">Männlich</option>
      <option value="F">Weiblich</option>
    </select>
    <button type="submit" class="button">Hinzufügen</button>
  </form>
<div class="section">
  <h2>CSV-Datei hochladen</h2>
  <p>Format wie folgt in Spalten: Vorname,Nachname,Geschlecht(M oder F),Jugend(j oder n),Position(AA,MB oder Z),Leistungsniveau(1,2 oder 3 - 1 = sehr gut),Spiele(1-...),Punkte(1-...) -> Beispielzeile: Vica,M.,F,n,Z,2,, oder: Noah,E.,M,j,,2,,</p>
  <input type="file" id="csvFileInput" accept=".csv" />
  <button id="uploadCSVButton" class="button">CSV importieren</button>
  <div id="uploadMessage" class="message"></div>
</div>

  <div id="playerMessage" class="message"></div>
</div>

<!-- SPIELER-TABELLE -->
<div class="section">
  <h2>Spielerliste / Punktetabelle</h2>
  <table id="playerTable">
    <thead>
      <tr>
        <th data-sort="name">Name</th>
        <th class="pos-col"   data-sort="position">Position</th>
        <th class="leist-col" data-sort="leistung">Leistung</th>
        <th class="gesch-col" data-sort="geschlecht">Geschlecht</th>
        <th data-sort="spiele">Spiele</th>
        <th data-sort="punkte">Punkte</th>
        <th>Aktionen</th>
      </tr>
    </thead>
    <tbody id="playerTableBody"></tbody>
  </table>
</div>

<!-- TEAMS LOSEN -->
<div class="section">
  <h2>Teams Losen</h2>

  <label>Anzahl Teams:</label>
  <input type="number" id="numberOfTeams" value="6" min="1" style="width:50px;" /><br><br>
  <label>Erwachsene pro Erw.Team:</label>
  <input type="number" id="adultTeamSize" value="6" min="1" style="width:50px;" /><br><br>
  <label>Erwachsene pro Mixed-Team:</label>
  <input type="number" id="adultPerMixedTeam" value="1" min="1" style="width:50px;" /><br><br>
  <label>Jugend pro Mixed-Team:</label>
  <input type="number" id="youthPerMixedTeam" value="2" min="1" style="width:50px;" /><br><br>

  <button id="previewButton" class="button">Vorschau Losen</button>
  <button id="applyPreviewButton" class="button" disabled>Anwenden</button>
  <button id="exportButton" class="button export-button">Ergebnisse Exportieren</button>

  <div id="unassignedPlayersSection" class="section" style="display:none;">
    <h3>Nicht zugeteilte Spieler</h3>
    <div id="unassignedAdults" class="player-list"></div>
    <div id="unassignedYouth" class="player-list"></div>
  </div>
</div>

<!-- ERGEBNISSE-BLOCK -->
<div class="section" id="resultsSection" style="display:none;">
  <h2>Ergebnisse</h2>

  <h3>Erwachsenenteams</h3>
  <div id="adultTeamsList" class="team-list"></div>
  <h3>Gemischte Teams</h3>
  <div id="mixedTeamsList" class="team-list"></div>

  <h3>Paarungen</h3>
  <div class="team-list">
    <h4>Erwachsenen Matches</h4>
    <div id="adultMatches"></div>
    <h4>Gemischte Matches</h4>
    <div id="mixedMatches"></div>

    <button id="undoLastMatchButton" class="button" style="background-color:#6c757d; margin-top:10px;">
      Letztes Match rückgängig
    </button>
  </div>
</div>

<!-- VORSCHAU-MODAL -->
<div id="feedbackModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Vorschau der Teams</h2>
    <div id="feedbackContent"></div>
  </div>
</div>

<script>
/* ========== NEU HINZUGEFÜGT ========== 
   => Eindeutige Kurz-Namen und LocalStorage
======================================= */
function generateUniqueShortNames() {
  const allPlayers = [...adultPlayers, ...youthPlayers];
  const usedShortNames = new Set();
  allPlayers.forEach(player => {
    player.ShortName = createShortName(player.Name, usedShortNames);
  });
}

function createShortName(fullName, usedSet) {
  const parts = fullName.trim().split(/\s+/);
  const firstName = parts[0];
  const lastName  = parts[parts.length - 1];
  let shortName = '';
  for (let i = 2; i <= lastName.length; i++) {
    const snippet = lastName.substring(0, i);
    shortName = firstName + ' ' + snippet + '.';
    if (!usedSet.has(shortName)) {
      usedSet.add(shortName);
      return shortName;
    }
  }
  shortName = firstName + ' ' + lastName + '.';
  usedSet.add(shortName);
  return shortName;
}

/* LOCAL STORAGE FUNKTIONEN */
function saveToLocalStorage() {
  localStorage.setItem('adultPlayers', JSON.stringify(adultPlayers));
  localStorage.setItem('youthPlayers', JSON.stringify(youthPlayers));
  localStorage.setItem('matchHistoryStack', JSON.stringify(matchHistoryStack));
}
function loadFromLocalStorage() {
  const storedAdults = localStorage.getItem('adultPlayers');
  const storedYouth = localStorage.getItem('youthPlayers');
  const storedHistory = localStorage.getItem('matchHistoryStack');

  if (storedAdults) {
    adultPlayers = JSON.parse(storedAdults);
  }
  if (storedYouth) {
    youthPlayers = JSON.parse(storedYouth);
  }
  if (storedHistory) {
    matchHistoryStack = JSON.parse(storedHistory);
  }
}

/* ========================================
   1) GLOBALE ARRAYS
======================================== */
let adultPlayers = [
  // { Name: "Leon K.", Position: "MB", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  // { Name: "Vica M.", Position: "Z", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 }
];

let youthPlayers = [
  // { Name: "Noah E.", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  // { Name: "Leila O.", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 }
 ]; 

let previewAdultTeams=[];
let previewMixedTeams=[];
let adultTeams=[];
let mixedTeams=[];
let matchHistoryStack=[];

// Sortier-Richtungen
let sortDirections={
  name:'asc', position:'asc', leistung:'asc', geschlecht:'asc',
  spiele:'asc', punkte:'asc'
};

/* ========================================
   2) DOM ELEMENTS
======================================== */
const toggleDetails= document.getElementById('toggleDetails');
const addPlayerForm= document.getElementById('addPlayerForm');
const playerMessageDiv= document.getElementById('playerMessage');
const playerTableBody= document.getElementById('playerTableBody');

const numberOfTeamsInput    = document.getElementById('numberOfTeams');
const adultTeamSizeInput    = document.getElementById('adultTeamSize');
const adultPerMixedTeamInput= document.getElementById('adultPerMixedTeam');
const youthPerMixedTeamInput= document.getElementById('youthPerMixedTeam');

const previewButton      = document.getElementById('previewButton');
const applyPreviewButton = document.getElementById('applyPreviewButton');
const exportButton       = document.getElementById('exportButton');
const undoLastMatchButton= document.getElementById('undoLastMatchButton');

const resultsSection     = document.getElementById('resultsSection');
const adultTeamsListDiv  = document.getElementById('adultTeamsList');
const mixedTeamsListDiv  = document.getElementById('mixedTeamsList');
const adultMatchesDiv    = document.getElementById('adultMatches');
const mixedMatchesDiv    = document.getElementById('mixedMatches');

const unassignedPlayersSection= document.getElementById('unassignedPlayersSection');
const unassignedAdultsDiv     = document.getElementById('unassignedAdults');
const unassignedYouthDiv      = document.getElementById('unassignedYouth');

const feedbackModal     = document.getElementById('feedbackModal');
const feedbackContent   = document.getElementById('feedbackContent');
const feedbackCloseSpan = document.getElementsByClassName('close')[0];

/* ========================================
   3) ONLOAD
======================================== */
window.onload= function(){
  // => Erst localStorage-Daten laden
  loadFromLocalStorage();
  // => Dann ShortNames generieren + Tabelle + Sortierung
  generateUniqueShortNames();
  renderPlayerTable();
  initSortingHeaders();
};

/* ========================================
   4) TOGGLE DETAILS
======================================== */
toggleDetails.addEventListener('change', ()=>{
  renderPlayerTable();
  toggleDetailColumns(); 
});

// => Spalten ein/ausblenden
function toggleDetailColumns(){
  const show= toggleDetails.checked;
  document.querySelectorAll('.pos-col').forEach(el=> el.style.display   = show? '':'none');
  document.querySelectorAll('.leist-col').forEach(el=> el.style.display = show? '':'none');
  document.querySelectorAll('.gesch-col').forEach(el=> el.style.display = show? '':'none');
}

/* ========================================
   5) GEMEINSAME SPIELER-TABELLE
======================================== */
function renderPlayerTable(){
  playerTableBody.innerHTML='';
  const showDetails= toggleDetails.checked;

  // 1) Erwachsene
  adultPlayers.forEach((p, idx)=>{
    const tr= createPlayerRow(p, 'adult', idx, showDetails);
    tr.classList.add('adult-player');
    playerTableBody.appendChild(tr);
  });
  // 2) Jugend
  youthPlayers.forEach((p, idx)=>{
    const tr= createPlayerRow(p, 'youth', idx, showDetails);
    tr.classList.add('youth-player');
    playerTableBody.appendChild(tr);
  });

  toggleDetailColumns();
}

function createPlayerRow(playerObj, type, idx, showDetails){
  const tr= document.createElement('tr');
  let displayName = showDetails ? playerObj.Name : (playerObj.ShortName || playerObj.Name);

  const pos   = (type==='adult')? (playerObj.Position||'') : '';
  const lei   = playerObj.Leistung || '';
  const gesch = playerObj.Geschlecht || '';

  tr.innerHTML= `
    <td>${displayName}</td>
    <td class="pos-col">${pos}</td>
    <td class="leist-col">${lei}</td>
    <td class="gesch-col">${gesch}</td>
    <td>${playerObj.Spiele}</td>
    <td>${playerObj.Punkte}</td>
    <td>
      <button class="adjust-button" onclick="adjustPoints('${type}', ${idx}, 1)">+Punkt</button>
      <button class="adjust-button" onclick="adjustPoints('${type}', ${idx}, -1)">-Punkt</button>
      <button class="adjust-button" onclick="adjustGames('${type}', ${idx}, 1)">+Spiel</button>
      <button class="adjust-button" onclick="adjustGames('${type}', ${idx}, -1)">-Spiel</button>
      <button class="adjust-button" onclick="editPlayer('${type}', ${idx})">Bearbeiten</button>
      <button class="adjust-button" onclick="deletePlayer('${type}', ${idx})">Löschen</button>
    </td>
  `;
  return tr;
}

/* ========================================
   6) SPIELER HINZUFÜGEN
======================================== */
addPlayerForm.addEventListener('submit',(e)=>{
  e.preventDefault();
  const name= document.getElementById('playerName').value.trim();
  const type= document.getElementById('playerType').value;
  const position= document.getElementById('playerPosition').value;
  const leistung= document.getElementById('playerLeistung').value;
  const geschlecht= document.getElementById('playerGeschlecht').value;

  if(!name || !type || !leistung || !geschlecht){
    playerMessageDiv.textContent="Bitte alle Felder ausfüllen!";
    playerMessageDiv.className='message error';
    return;
  }
  if(type==='adult'){
    if(adultPlayers.some(a=>a.Name.toLowerCase()=== name.toLowerCase())){
      playerMessageDiv.textContent="Name existiert schon (Erw).";
      playerMessageDiv.className='message error';
      return;
    }
    adultPlayers.push({
      Name:name, Position:(position||''), Leistung:leistung, Geschlecht:geschlecht,
      Spiele:0, Punkte:0
    });
  } else {
    if(youthPlayers.some(y=>y.Name.toLowerCase()=== name.toLowerCase())){
      playerMessageDiv.textContent="Name existiert schon (Jugend).";
      playerMessageDiv.className='message error';
      return;
    }
    youthPlayers.push({
      Name:name, Leistung:leistung, Geschlecht:geschlecht,
      Spiele:0, Punkte:0
    });
  }
  generateUniqueShortNames();
  playerMessageDiv.textContent=`${name} (Typ:${type}) hinzugefügt.`;
  playerMessageDiv.className='message success';
  addPlayerForm.reset();
  renderPlayerTable();

  // Hier speichern, damit Daten nach Reload erhalten bleiben:
  saveToLocalStorage();
});

/* EDIT / DELETE */
window.editPlayer=function(type, idx){
  let arr= (type==='adult')? adultPlayers : youthPlayers;
  const p= arr[idx];
  const newName= prompt("Neuen Namen eingeben:", p.Name);
  if(newName && newName.trim()!==''){
    p.Name= newName.trim();
    generateUniqueShortNames();
    renderPlayerTable();
    saveToLocalStorage();
  }
};
window.deletePlayer=function(type, idx){
  let arr= (type==='adult')? adultPlayers : youthPlayers;
  if(!confirm(`Wirklich ${arr[idx].Name} löschen?`)) return;
  arr.splice(idx,1);
  generateUniqueShortNames();
  renderPlayerTable();
  saveToLocalStorage();
};

/* PUNKTE / SPIELE */
window.adjustPoints=function(type, idx, delta){
  let arr= (type==='adult')? adultPlayers : youthPlayers;
  if(delta<0 && arr[idx].Punkte<=0){
    alert("Punkte können nicht negativ werden!");
    return;
  }
  arr[idx].Punkte+= delta;
  renderPlayerTable();
  saveToLocalStorage();
};
window.adjustGames=function(type, idx, delta){
  let arr= (type==='adult')? adultPlayers : youthPlayers;
  if(delta<0 && arr[idx].Spiele<=0){
    alert("Spiele können nicht negativ werden!");
    return;
  }
  arr[idx].Spiele+= delta;
  renderPlayerTable();
  saveToLocalStorage();
};

/* ========================================
   7) SORTIERUNG (TH-Klick)
======================================== */
function initSortingHeaders(){
  document.querySelectorAll('#playerTable thead th[data-sort]').forEach(th=>{
    th.addEventListener('click', ()=>{
      const criterion= th.getAttribute('data-sort');
      const currentDir= sortDirections[criterion];
      const newDir= (currentDir==='asc')? 'desc' : 'asc';
      sortDirections[criterion]= newDir;
      sortPlayers(criterion,newDir);
    });
  });
}

function sortPlayers(crit, dir){
  const mul= (dir==='asc')? 1 : -1;
  adultPlayers.sort((a,b)=> compareByCrit(a,b,crit)*mul);
  youthPlayers.sort((a,b)=> compareByCrit(a,b,crit)*mul);
  renderPlayerTable();
  saveToLocalStorage(); // auch nach Sortierung, falls gewünscht
}

function compareByCrit(a, b, crit) {
  let aVal, bVal;
  if (crit === 'name') {
    aVal = a.Name || '';
    bVal = b.Name || '';
    return aVal.localeCompare(bVal);
  } else if (crit === 'position') {
    aVal = a.Position || '';
    bVal = b.Position || '';
    return aVal.localeCompare(bVal);
  } else if (crit === 'geschlecht') {
    aVal = a.Geschlecht || '';
    bVal = b.Geschlecht || '';
    return aVal.localeCompare(bVal);
  } else if (crit === 'leistung') {
    return parseInt(a.Leistung || 0) - parseInt(b.Leistung || 0);
  } else if (crit === 'spiele') {
    return parseInt(a.Spiele || 0) - parseInt(b.Spiele || 0);
  } else if (crit === 'punkte') {
    return parseInt(a.Punkte || 0) - parseInt(b.Punkte || 0);
  }
  return 0;
}

/* ========================================
   8) LOSEN: VORSCHAU + ANWENDEN
======================================== */
previewButton.addEventListener('click',()=>{
  const numTeams= parseInt(numberOfTeamsInput.value);
  const sizeAdult= parseInt(adultTeamSizeInput.value);
  const adultMix=  parseInt(adultPerMixedTeamInput.value);
  const youthMix=  parseInt(youthPerMixedTeamInput.value);

  let sortedAdults=[...adultPlayers];
  sortedAdults.sort((a,b)=>{
    if(a.Spiele!== b.Spiele) return a.Spiele - b.Spiele;
    if(a.Leistung!== b.Leistung) return (parseInt(a.Leistung) - parseInt(b.Leistung));
    return Math.random()-0.5;
  });
  let sortedYouth=[...youthPlayers];
  sortedYouth.sort((a,b)=>{
    if(a.Spiele!==b.Spiele) return a.Spiele - b.Spiele;
    if(a.Leistung!== b.Leistung) return (parseInt(a.Leistung)- parseInt(b.Leistung));
    return Math.random()-0.5;
  });

  const neededAdults= (numTeams*sizeAdult)+(numTeams*adultMix);
  const neededYouth= (numTeams*youthMix);

  if(sortedAdults.length< neededAdults){
    alert(`Nicht genug Erwachsene (${neededAdults} benötigt)!`);
    return;
  }
  if(sortedYouth.length< neededYouth){
    alert(`Nicht genug Jugend (${neededYouth} benötigt)!`);
    return;
  }

  let adultTeamSlice   = sortedAdults.slice(0, numTeams*sizeAdult);
  let adultMixedSlice  = sortedAdults.slice(numTeams*sizeAdult, numTeams*sizeAdult+(numTeams*adultMix));
  let youthMixedSlice  = sortedYouth.slice(0, numTeams*youthMix);

  previewAdultTeams=[];
  for(let i=0;i<numTeams;i++){
    previewAdultTeams.push(
      adultTeamSlice.slice(i*sizeAdult,(i+1)*sizeAdult)
    );
  }
  previewMixedTeams=[];
  for(let i=0;i<numTeams;i++){
    let am= adultMixedSlice.slice(i*adultMix,(i+1)*adultMix);
    let ym= youthMixedSlice.slice(i*youthMix,(i+1)*youthMix);
    previewMixedTeams.push([...am, ...ym]);
  }

  showFeedbackModal(previewAdultTeams, previewMixedTeams);
  applyPreviewButton.disabled= false;

  let usedAdultNames= adultTeamSlice.map(a=>a.Name).concat(adultMixedSlice.map(a=>a.Name));
  let unassignedA= adultPlayers.filter(a=> !usedAdultNames.includes(a.Name));
  let usedYouthNames= youthMixedSlice.map(a=>a.Name);
  let unassignedY= youthPlayers.filter(y=> !usedYouthNames.includes(y.Name));

  if(unassignedA.length>0){
    unassignedAdultsDiv.innerHTML='';
    unassignedA.forEach(u=>{
      const d=document.createElement('div');
      d.className='player-item';
      let disp = toggleDetails.checked ? u.Name : (u.ShortName || u.Name);
      d.textContent= `${disp}`;
      unassignedAdultsDiv.appendChild(d);
    });
  } else {
    unassignedAdultsDiv.innerHTML='<p>Keine nicht zugeteilten Erwachsenen.</p>';
  }
  if(unassignedY.length>0){
    unassignedYouthDiv.innerHTML='';
    unassignedY.forEach(u=>{
      const d=document.createElement('div');
      d.className='player-item';
      let disp = toggleDetails.checked ? u.Name : (u.ShortName || u.Name);
      d.textContent= `${disp}`;
      unassignedYouthDiv.appendChild(d);
    });
  } else {
    unassignedYouthDiv.innerHTML='<p>Keine nicht zugeteilten Jugendspieler.</p>';
  }
  unassignedPlayersSection.style.display= (unassignedA.length>0 || unassignedY.length>0)? '' : 'none';
});

applyPreviewButton.addEventListener('click', ()=>{
  adultTeams= JSON.parse(JSON.stringify(previewAdultTeams));
  mixedTeams= JSON.parse(JSON.stringify(previewMixedTeams));
  matchHistoryStack = [];
  displayResults(adultTeams, mixedTeams);
  applyPreviewButton.disabled= true;
  saveToLocalStorage(); // <= Speichern, wenn neue Teams offiziell angenommen wurden
});

/* ========================================
   9) ERGEBNISSE + MATCHES
======================================== */
function displayResults(aTeams, mTeams){
  resultsSection.style.display='';
  adultTeamsListDiv.innerHTML='';
  mixedTeamsListDiv.innerHTML='';

  aTeams.forEach((team,i)=>{
    const names= team.map(p=>p.Name).join(', ');
    let div= document.createElement('div');
    div.className='adult-team';
    div.innerHTML=`<strong>Erwachsenenteam ${i+1}:</strong> ${names}`;
    adultTeamsListDiv.appendChild(div);
  });
  mTeams.forEach((team,i)=>{
    const names= team.map(p=>p.Name).join(', ');
    let div= document.createElement('div');
    div.className='mixed-team';
    div.innerHTML=`<strong>Team Jugend ${i+1}:</strong> ${names}`;
    mixedTeamsListDiv.appendChild(div);
  });

  createMatches(aTeams,mTeams);
  renderPlayerTable();
  saveToLocalStorage();
}

function createMatches(aTeams, mTeams){
  adultMatchesDiv.innerHTML = '';
  mixedMatchesDiv.innerHTML = '';

  for(let i=0; i<aTeams.length; i+=2){
    if(i+1 < aTeams.length){
      const matchDiv = document.createElement('div');
      matchDiv.className = 'match-item';
      const matchIndex = Math.floor(i/2);
      matchDiv.innerHTML = `
        <strong>Feld ${matchIndex + 1}:</strong>
        Erwachsenenteam ${i+1} vs. Erwachsenenteam ${i+2}
        <button class="button" 
                data-match-type="adult" 
                data-match-index="${matchIndex}" 
                data-winning-team="${i}">
          Gewinner: Team ${i+1}
        </button>
        <button class="button" 
                data-match-type="adult" 
                data-match-index="${matchIndex}" 
                data-winning-team="${i+1}">
          Gewinner: Team ${i+2}
        </button>
      `;
      adultMatchesDiv.appendChild(matchDiv);
    }
  }

  for(let i=0; i<mTeams.length; i+=2){
    if(i+1 < mTeams.length){
      const matchDiv = document.createElement('div');
      matchDiv.className='match-item';
      const matchIndex = Math.floor(i/2);
      matchDiv.innerHTML = `
        <strong>Gemischtes Feld ${matchIndex + 1}:</strong>
        Team Jugend ${i+1} vs. Team Jugend ${i+2}
        <button class="button" 
                data-match-type="mixed" 
                data-match-index="${matchIndex}" 
                data-winning-team="${i}">
          Gewinner: Team ${i+1}
        </button>
        <button class="button" 
                data-match-type="mixed" 
                data-match-index="${matchIndex}" 
                data-winning-team="${i+1}">
          Gewinner: Team ${i+2}
        </button>
      `;
      mixedMatchesDiv.appendChild(matchDiv);
    }
  }

  document.querySelectorAll('.match-item .button').forEach(btn => {
    btn.addEventListener('click', function(){
      const matchType = this.getAttribute('data-match-type');
      const winIdx = parseInt(this.getAttribute('data-winning-team'));
      recordMatchResult(matchType, winIdx);
      this.parentNode.querySelectorAll('button').forEach(b => b.disabled = true);
    });
  });

  disablePlayedMatches();
}
function disablePlayedMatches(){
  matchHistoryStack.forEach(match => {
    const { matchType, winningTeamIndex, losingTeamIndex } = match;
    const buttons = document.querySelectorAll(`.match-item .button[data-match-type="${matchType}"]`);
    buttons.forEach(btn => {
      const btnWinIdx = parseInt(btn.getAttribute('data-winning-team'));
      if(btnWinIdx === winningTeamIndex || btnWinIdx === losingTeamIndex){
        btn.disabled = true;
      }
    });
  });
}

function recordMatchResult(matchType, winningTeamIndex){
  let winningTeam=[], losingTeam=[];
  let losingTeamIndex=-1;

  if(matchType==='adult'){
    winningTeam= adultTeams[winningTeamIndex];
    let opp= (winningTeamIndex%2===0)? winningTeamIndex+1: winningTeamIndex-1;
    losingTeam= adultTeams[opp];
    losingTeamIndex= opp;
  } else {
    winningTeam= mixedTeams[winningTeamIndex];
    let opp= (winningTeamIndex%2===0)? winningTeamIndex+1: winningTeamIndex-1;
    losingTeam= mixedTeams[opp];
    losingTeamIndex= opp;
  }

  winningTeam.forEach(p=>{
    let real= findPlayerByName(p.Name);
    if(real){
      real.Punkte++;
      real.Spiele++;
    }
  });
  losingTeam.forEach(p=>{
    let real= findPlayerByName(p.Name);
    if(real){
      real.Spiele++;
    }
  });

  matchHistoryStack.push({ matchType, winningTeamIndex, losingTeamIndex });
  alert(`Team ${winningTeamIndex+1} hat gewonnen!`);
  renderPlayerTable();
  saveToLocalStorage();
}

/* MATCH RÜCKGÄNGIG */
undoLastMatchButton.addEventListener('click', undoLastMatch);
function undoLastMatch(){
  if(matchHistoryStack.length === 0){
    alert("Kein Match zum Rückgängig machen!");
    return;
  }
  const lastMatch = matchHistoryStack.pop();
  const { matchType, winningTeamIndex, losingTeamIndex } = lastMatch;

  let wTeam, lTeam;
  if(matchType === 'adult'){
    wTeam = adultTeams[winningTeamIndex];
    lTeam = adultTeams[losingTeamIndex];
  } else {
    wTeam = mixedTeams[winningTeamIndex];
    lTeam = mixedTeams[losingTeamIndex];
  }

  wTeam.forEach(p=>{
    let real= findPlayerByName(p.Name);
    if(real){
      if(real.Punkte > 0) real.Punkte--;
      if(real.Spiele > 0) real.Spiele--;
    }
  });
  lTeam.forEach(p=>{
    let real= findPlayerByName(p.Name);
    if(real && real.Spiele > 0) real.Spiele--;
  });

  alert("Letztes Match rückgängig gemacht!");
  renderPlayerTable();
  createMatches(adultTeams, mixedTeams);
  saveToLocalStorage();
}

/* ========================================
   10) CSV EXPORT
======================================== */
exportButton.addEventListener('click', ()=>{
  let csv = generateCSV();
  downloadCSV(csv,'spielergebnisse.csv');
});
function generateCSV(){
  // Aktualisierter Header mit Spiele und Punkte
  let csv = 'Vorname,Nachname,Geschlecht,Jugend,Position,Leistungsniveau,Spiele,Punkte\n';
  
  // Erwachsene Spieler
  adultPlayers.forEach(p => {
    const { vorname, nachname } = splitName(p.Name);
    const geschlecht = p.Geschlecht || '';
    const jugend = 'n'; // 'n' für Erwachsene
    const position = p.Position || '';
    const leistungsniveau = p.Leistung || '';
    const spiele = p.Spiele || 0;
    const punkte = p.Punkte || 0;
    csv += `${vorname},${nachname},${geschlecht},${jugend},${position},${leistungsniveau},${spiele},${punkte}\n`;
  });

  // Jugend Spieler
  youthPlayers.forEach(p => {
    const { vorname, nachname } = splitName(p.Name);
    const geschlecht = p.Geschlecht || '';
    const jugend = 'j'; // 'j' für Jugend
    const position = ''; // leer für Jugendspieler
    const leistungsniveau = p.Leistung || '';
    const spiele = p.Spiele || 0;
    const punkte = p.Punkte || 0;
    csv += `${vorname},${nachname},${geschlecht},${jugend},${position},${leistungsniveau},${spiele},${punkte}\n`;
  });

  return csv;
}

function splitName(fullName) {
  const parts = fullName.trim().split(/\s+/);
  const vorname = parts[0];
  const nachname = parts.slice(1).join(' ') || '';
  return { vorname, nachname };
}

function downloadCSV(csvContent, filename){
  const blob= new Blob([csvContent],{type:'text/csv;charset=utf-8;'});
  if(navigator.msSaveBlob){
    navigator.msSaveBlob(blob, filename);
  } else {
    const link= document.createElement('a');
    if(link.download!==undefined){
      const url= URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility='hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  }
}

function splitName(fullName) {
  const parts = fullName.trim().split(/\s+/);
  const vorname = parts[0];
  const nachname = parts.slice(1).join(' ') || '';
  return { vorname, nachname };
}

/* ========================================
   11) HILFSFUNKTION
======================================== */
function findPlayerByName(name){
  let p= adultPlayers.find(a=>a.Name=== name);
  if(p) return p;
  return youthPlayers.find(y=>y.Name=== name);
}

/* MODAL VORSCHAU */
function showFeedbackModal(aTeams,mTeams){
  const modal= feedbackModal;
  const span= feedbackCloseSpan;
  let html=`<h3>Erwachsenenteams (Vorschau):</h3>`;
  aTeams.forEach((t,i)=>{
    const names= t.map(p=>p.Name).join(', ');
    html+= `<p><strong>Team ${i+1}:</strong> ${names}</p>`;
  });
  html+= `<h3>Gemischte Teams (Vorschau):</h3>`;
  mTeams.forEach((t,i)=>{
    const names= t.map(p=>p.Name).join(', ');
    html+= `<p><strong>Team ${i+1}:</strong> ${names}</p>`;
  });
  feedbackContent.innerHTML= html;
  modal.style.display='block';
  span.onclick= ()=> modal.style.display='none';
  window.onclick=(e)=>{
    if(e.target=== modal){
      modal.style.display='none';
    }
  };
}
document.getElementById('uploadCSVButton').addEventListener('click', handleCSVUpload);

function handleCSVUpload() {
  const fileInput = document.getElementById('csvFileInput');
  const uploadMsg = document.getElementById('uploadMessage');

  if(!fileInput.files || fileInput.files.length===0){
    uploadMsg.textContent = "Keine Datei ausgewählt!";
    uploadMsg.className = 'message error';
    return;
  }
  const file = fileInput.files[0];
  if(!file.name.toLowerCase().endsWith('.csv')){
    uploadMsg.textContent = "Bitte eine CSV-Datei wählen!";
    uploadMsg.className = 'message error';
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const csvText = e.target.result;
    let msg = importPlayersFromCSV(csvText);
    uploadMsg.textContent = msg;
    uploadMsg.className = 'message success';

    // optional: zurücksetzen
    fileInput.value='';
  };
  reader.readAsText(file,'UTF-8');
}

function importPlayersFromCSV(csvText) {
  // 1) Zeilen aufsplitten
  const lines = csvText.trim().split('\n');
  if (lines.length < 2) {
    return "CSV enthält keine Datenzeilen!";
  }

  // 2) Wir gehen ab Zeile 2 (Index=1) durch, da Zeile 0 der Header ist
  let countImported = 0;
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue; // leere Zeile überspringen

    // => Spalten aufsplitten
    const parts = line.split(',');

    // Wir erwarten 8 Spalten:
    // (0) Vorname, (1) Nachname, (2) Geschlecht, (3) Jugend, (4) Position, (5) Leistungsniveau, (6) Spiele, (7) Punkte
    if (parts.length < 8) {
      console.warn("Unvollständige Zeile:", line);
      continue;
    }

    let csvVorname         = parts[0].trim(); // z.B. "Frank Peter"
    let csvNachname        = parts[1].trim(); // z.B. "Mechten"
    let csvGeschlecht      = parts[2].trim(); // "M" oder "F"
    let csvJugend          = parts[3].trim(); // "j" oder "n"
    let csvPosition        = parts[4].trim(); // "MB", "AA", ... oder leer
    let csvLeistungsniveau = parts[5].trim(); // "1", "2", "3"
    let csvSpiele          = parseInt(parts[6].trim()) || 0; // "Spiele" als Zahl
    let csvPunkte          = parseInt(parts[7].trim()) || 0; // "Punkte" als Zahl

    // => Vorname + Nachname => Name
    let fullName = csvVorname + " " + csvNachname;

    // => Entscheiden: Jugend oder Erwachsene
    // Falls csvJugend=="j" => youthPlayers, sonst adultPlayers
    let isYouth = (csvJugend.toLowerCase() === 'j');

    // => Je nach Typ in das passende Array
    let arr = isYouth ? youthPlayers : adultPlayers;

    // => Prüfung: existiert Name schon in diesem Array?
    let alreadyExists = arr.some(
      p => p.Name.toLowerCase() === fullName.toLowerCase()
    );
    if (alreadyExists) {
      console.log("Überspringe, da Name schon existiert:", fullName);
      continue;
    }

    // => Neues Spieler-Objekt
    let newPlayer = {
      Name: fullName,
      Position: isYouth ? '' : (csvPosition || ''), // Nur bei Erwachsenen relevant
      Leistung: csvLeistungsniveau,
      Geschlecht: csvGeschlecht,
      Spiele: csvSpiele, // Spiele aus CSV zuweisen
      Punkte: csvPunkte  // Punkte aus CSV zuweisen
    };

    // => Ins Array packen
    arr.push(newPlayer);
    countImported++;
  }

  // => ShortNames / Render / Speichern
  generateUniqueShortNames();
  renderPlayerTable();
  saveToLocalStorage();

  return `${countImported} Spieler aus CSV importiert.`;
}

</script>
</body>
</html>
