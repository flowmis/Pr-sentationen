<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>TSV Ellwangen Team-Maker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
    }
    h1, h2, h3, h4 {
      margin-top: 40px;
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      margin-bottom: 20px;
      background-color: #fff;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: left;
      cursor: pointer; /* Wichtig für Sortierklick */
    }
    th {
      background-color: #4CAF50;
      color: white;
    }
    .player-list, .team-list, .matches-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #aaa;
      padding: 10px;
      margin-top: 10px;
      background-color: #fff;
    }
    .player-item, .team-item, .match-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
      padding: 5px;
      border-bottom: 1px solid #ddd;
    }
    .add-player-form input, .add-player-form select, .add-player-form button {
      margin-right: 10px;
      padding: 5px;
      font-size: 14px;
    }
    .section {
      margin-bottom: 40px;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .button {
      padding: 8px 16px;
      background-color: #28a745;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
      margin-left: 5px;
      transition: background-color 0.3s;
    }
    .button:hover {
      background-color: #218838;
    }
    .message {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
    }
    .adjust-button {
      padding: 4px 8px;
      background-color: #007bff;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 12px;
      border-radius: 4px;
      margin-left: 5px;
      transition: background-color 0.3s;
    }
    .adjust-button:hover {
      background-color: #0069d9;
    }
    .button:disabled, .adjust-button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    .modal {
      display: none; 
      position: fixed; 
      z-index: 999; 
      padding-top: 100px; 
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      border-radius: 8px;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover,
    .close:focus {
      color: black;
    }
    .export-button {
      background-color: #17a2b8;
    }
    .export-button:hover {
      background-color: #138496;
    }

    /* Größere Darstellung für Teams */
    .team-item {
      font-size: 1.2rem;
    }

    /* Farbliche Kennzeichnung (optional) */
    .adult-player {
      background-color: #ffe8e8; 
    }
    .youth-player {
      background-color: #e8f7ff; 
    }

  </style>
</head>
<body>

<h1>TSV Ellwangen Team-Maker</h1>

<div class="section">
  <h2>Spieler</h2>
  <label style="margin-right:20px;">
    <input type="checkbox" id="toggleDetails" unchecked>
    Details anzeigen
  </label>
  <button id="undoButton" class="button" style="background-color:#6c757d;">Rückgängig</button>

  <div id="playerList" class="player-list"></div>
  
  <h3>Spieler hinzufügen</h3>
  <form id="addPlayerForm" class="add-player-form">
    <input type="text" id="playerName" placeholder="Name" required>
    <select id="playerType" required>
      <option value="" disabled selected>Erwachsen/Jugend</option>
      <option value="adult">Erwachsene/r</option>
      <option value="youth">Jugend</option>
    </select>
    <select id="playerPosition">
      <option value="" disabled selected>Position (nur Erwachsene)</option>
      <option value="MB">MB</option>
      <option value="AA">AA</option>
      <option value="Z">Z</option>
    </select>
    <select id="playerLeistung" required>
      <option value="" disabled selected>Leistung</option>
      <option value="1">1 - Sehr gut</option>
      <option value="2">2 - Gut</option>
      <option value="3">3 - Weniger gut</option>
    </select>
    <select id="playerGeschlecht" required>
      <option value="" disabled selected>Geschlecht</option>
      <option value="M">Männlich</option>
      <option value="F">Weiblich</option>
    </select>
    <button type="submit" class="button">Hinzufügen</button>
  </form>
  <div id="playerMessage" class="message"></div>
</div>

<div class="section">
  <h2>Teams Losen</h2>

  <!-- Checkboxen -->
  <div>
    <label><input type="checkbox" id="useLeistung" checked>Leistung berücksichtigen</label>
    <label style="margin-left:20px;"><input type="checkbox" id="useGeschlecht" checked>Geschlecht berücksichtigen</label>
    <label style="margin-left:20px;"><input type="checkbox" id="usePosition" checked>Postionen berücksichtigen</label>
  </div>

  <div style="margin-top:20px;">
    <label>Anzahl der Erwachsenenfelder:</label>
    <input type="number" id="adultFields" value="3" style="width: 50px;">
    <label style="margin-left:20px;">Anzahl der Jugendfelder:</label>
    <input type="number" id="youthFields" value="3" style="width: 50px;">
  </div>

  <div style="margin-top:20px;">
    <label>Erwachsene pro Erwachsenen-Team:</label>
    <input type="number" id="adultTeamSize" value="6" min="1" style="width: 50px;">
  </div>
  <div style="margin-top:20px;">
    <label>Erwachsene pro Team Jugend:</label>
    <input type="number" id="adultPerMixedTeam" value="1" min="1" style="width: 50px;">
  </div>
  <div style="margin-top:20px;">
    <label>Jugendspieler pro Team Jugend:</label>
    <input type="number" id="youthPerMixedTeam" value="2" min="1" style="width: 50px;">
  </div>

  <button id="previewButton" class="button" style="margin-top:20px;">Vorschau Losen</button>
  <button id="applyPreviewButton" class="button" disabled>Anwenden</button>
  <button id="exportButton" class="button export-button">Ergebnisse Exportieren</button>

  <div id="unassignedPlayersSection" class="section" style="display:none;">
    <h3>Nicht zugeteilte Spieler</h3>
    <div id="unassignedAdults" class="player-list"></div>
    <div id="unassignedYouth" class="player-list"></div>
  </div>
</div>

<div class="section" id="resultsSection" style="display:none;">
  <h2>Ergebnisse</h2>

  <h3>Erwachsenenteams</h3>
  <div id="adultTeamsList" class="team-list"></div>
  <h3>Gemischte Teams</h3>
  <div id="mixedTeamsList" class="team-list"></div>

  <h3>Paarungen</h3>
  <div id="matchesList" class="team-list">
    <h4>Erwachsenen Matches</h4>
    <div id="adultMatches"></div>
    <h4>Gemischte Matches</h4>
    <div id="mixedMatches"></div>
  </div>

  <h3>Spielergebnisse und Punkte</h3>
  <table id="pointsTable">
    <thead>
      <tr>
        <th data-sort="name">Name</th>
        <th data-sort="spiele">Spiele</th>
        <th data-sort="punkte">Punkte</th>
        <th>Aktionen</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Feedback Modal -->
<div id="feedbackModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Vorschau der Teams</h2>
    <div id="feedbackContent"></div>
  </div>
</div>

<script>
/* ------------------------------------------------------------
   Globale Variablen

   'MixedGames' für Erwachsene -> zählt, wie oft Erwachsene 
   bereits in einem Mixed-Team (Jugend) mitgespielt haben.
------------------------------------------------------------ */
let adultPlayers = [
  { Name: "Alex K.", Position: "MB", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Leon K.", Position: "MB", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Franzi K.", Position: "AA", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Monja B.", Position: "MB", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Ali K.", Position: "Z", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Anna R.", Position: "AA", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Ben B.", Position: "MB", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Caro S.", Position: "MB", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Daniel E.", Position: "AA", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Daria A.", Position: "AA", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Elias K.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Elias S.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Emily K.", Position: "AA", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Fabian D.", Position: "MB", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Felina S.", Position: "AA", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Felix K.", Position: "AA", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Karrrrle", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Florian B.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Helene M.", Position: "AA", Leistung: "3", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Helene Maneth", Position: "AA", Leistung: "3", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Ida B.", Position: "MB", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Jan K.", Position: "MB", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Jannis E.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Jannis H.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Jannis W.", Position: "MB", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Joel D.", Position: "AA", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Johanna S.", Position: "MB", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Flo R.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Chris K.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Lauresa O.", Position: "AA", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Hannah B.", Position: "AA", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },

  { Name: "Jonas Labisch", Position: "Z", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Paul L.", Position: "Z", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Jonas Lingel.", Position: "Z", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Julian S.", Position: "AA", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Katharina B.", Position: "AA", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Katja H.", Position: "Z", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Lara K.", Position: "MB", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Leah B.", Position: "AA", Leistung: "3", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Marus H.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Lenard S.", Position: "Z", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Leni J.", Position: "AA", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Leo B.", Position: "AA", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Lina M.", Position: "AA", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Linus W.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Lucie N.", Position: "AA", Leistung: "3", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Martin U.", Position: "Z", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Max D.", Position: "AA", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Michi H.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Mieke K.", Position: "AA", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Nelly A.", Position: "MB", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Nicklas K.", Position: "MB", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Nikita S.", Position: "AA", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Patrick S.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Philipp K.", Position: "Z", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Pius M.", Position: "Z", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Robin W.", Position: "Z", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Ronja B.", Position: "AA", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Rune D.", Position: "Z", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Sara T.", Position: "Z", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Niko K.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Ludo N.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Sebastian M.", Position: "AA", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Steffi G.", Position: "Z", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Tom W.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Vica M.", Position: "Z", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 }
];

let youthPlayers = [
  { Name: "Noah E.", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Frieda M.", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Julia E.", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Elena C.", Leistung: "3", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Noemi R.", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Mirjam K.", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Jakob K.", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Bennett G.", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Annelie M.", Leistung: "3", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Alex Z.", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Laurenz J.", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "David S.", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Elya M.", Leistung: "3", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Emilia Hauf.", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Leila O.", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 }
 ]; 


let unassignedAdultsGlobal = [];
let unassignedYouthGlobal = [];

let adultTeams = [];
let mixedTeams = [];

let previewAdultTeams = [];
let previewMixedTeams = [];

let historyStack = [];
let sortDirections = { name: 'asc', spiele: 'asc', punkte: 'asc' };

/* ------------------------------------------------------------
   DOM-Elemente
------------------------------------------------------------ */
const toggleDetails = document.getElementById('toggleDetails');
const undoButton = document.getElementById('undoButton');
const playerListDiv = document.getElementById('playerList');
const addPlayerForm = document.getElementById('addPlayerForm');
const playerMessageDiv = document.getElementById('playerMessage');

const unassignedPlayersSection = document.getElementById('unassignedPlayersSection');
const unassignedAdultsDiv = document.getElementById('unassignedAdults');
const unassignedYouthDiv = document.getElementById('unassignedYouth');

const resultsSection = document.getElementById('resultsSection');
const adultTeamsListDiv = document.getElementById('adultTeamsList');
const mixedTeamsListDiv = document.getElementById('mixedTeamsList');
const adultMatchesDiv = document.getElementById('adultMatches');
const mixedMatchesDiv = document.getElementById('mixedMatches');
const pointsTableBody = document.querySelector('#pointsTable tbody');

const previewButton = document.getElementById('previewButton');
const applyPreviewButton = document.getElementById('applyPreviewButton');
const exportButton = document.getElementById('exportButton');

const adultFieldsInput = document.getElementById('adultFields');
const youthFieldsInput = document.getElementById('youthFields');
const adultTeamSizeInput = document.getElementById('adultTeamSize');
const adultPerMixedTeamInput = document.getElementById('adultPerMixedTeam');
const youthPerMixedTeamInput = document.getElementById('youthPerMixedTeam');

/* ------------------------------------------------------------
   Laden / Speichern (falls gewünscht, hier weggelassen)
------------------------------------------------------------ */
function loadData() {}
function saveData() {}

/* ------------------------------------------------------------
   Undo
------------------------------------------------------------ */
function saveHistory() {
  historyStack.push({
    adultPlayers: JSON.parse(JSON.stringify(adultPlayers)),
    youthPlayers: JSON.parse(JSON.stringify(youthPlayers))
  });
}
function undoLastChange(){
  if(historyStack.length>0){
    const lastState=historyStack.pop();
    adultPlayers=lastState.adultPlayers;
    youthPlayers=lastState.youthPlayers;
    renderPlayerList();
    updatePointsTable();
  } else {
    alert("Keine Änderung zum Rückgängig machen.");
  }
}
undoButton.addEventListener('click',undoLastChange);

/* ------------------------------------------------------------
   Spieler-Liste (keine [Erw.] / [Jug.] mehr)
   -> Details je nach toggleDetails
------------------------------------------------------------ */
function renderPlayerList() {
  playerListDiv.innerHTML='';

  const showDetails = toggleDetails.checked;

  // Erwachsene
  adultPlayers.forEach((player, index)=>{
    const div=document.createElement('div');
    div.className='player-item adult-player';

    const displayName= formatNameForList(player, showDetails);
    let detailText='';
    if(showDetails){
      detailText=` (Pos:${player.Position||"n/a"}, L:${player.Leitung}, G:${player.Geschlecht}, Mixed:${player.MixedGames??0})`;
    }
    div.innerHTML=`
      <span>${displayName}${detailText}</span>
      <div>
        <button class="button" onclick="editAdultPlayer(${index})">Bearbeiten</button>
        <button class="button" onclick="deleteAdultPlayer(${index})">Löschen</button>
      </div>
    `;
    playerListDiv.appendChild(div);
  });

  // Jugend
  youthPlayers.forEach((player,index)=>{
    const div=document.createElement('div');
    div.className='player-item youth-player';

    const displayName= formatNameForList(player, showDetails);
    let detailText='';
    if(showDetails){
      detailText=` (L:${player.Leitung}, G:${player.Geschlecht})`;
    }
    div.innerHTML=`
      <span>${displayName}${detailText}</span>
      <div>
        <button class="button" onclick="editYouthPlayer(${index})">Bearbeiten</button>
        <button class="button" onclick="deleteYouthPlayer(${index})">Löschen</button>
      </div>
    `;
    playerListDiv.appendChild(div);
  });
}

// Nur Vorname + 1. Buchstabe
function formatNameForList(player, showDetails){
  if(!showDetails){
    const parts=player.Name.split(' ');
    if(parts.length>1){
      return parts[0]+' '+parts[1].charAt(0)+'.';
    } else {
      return parts[0];
    }
  }
  return player.Name;
}

/* Edit-Funktionen */
window.editAdultPlayer=function(index){
  const player=adultPlayers[index];
  const newName=prompt("Neuen Namen eingeben:", player.Name);
  if(newName && newName.trim()!==''){
    saveHistory();
    player.Name=newName.trim();
    renderPlayerList();
    updatePointsTable();
  }
};
window.editYouthPlayer=function(index){
  const player=youthPlayers[index];
  const newName=prompt("Neuen Namen eingeben:", player.Name);
  if(newName && newName.trim()!==''){
    saveHistory();
    player.Name=newName.trim();
    renderPlayerList();
    updatePointsTable();
  }
};
window.deleteAdultPlayer=function(index){
  if(confirm("Wirklich löschen?")){
    saveHistory();
    adultPlayers.splice(index,1);
    renderPlayerList();
    updatePointsTable();
  }
};
window.deleteYouthPlayer=function(index){
  if(confirm("Wirklich löschen?")){
    saveHistory();
    youthPlayers.splice(index,1);
    renderPlayerList();
    updatePointsTable();
  }
};

/* ------------------------------------------------------------
   Spieler Hinzufügen
   => Falls Erwachsen: MixedGames=0 initialisieren
------------------------------------------------------------ */
addPlayerForm.addEventListener('submit',(e)=>{
  e.preventDefault();
  const name=document.getElementById('playerName').value.trim();
  const type=document.getElementById('playerType').value;
  const position=document.getElementById('playerPosition').value;
  const leistung=document.getElementById('playerLeistung').value;
  const geschlecht=document.getElementById('playerGeschlecht').value;

  if(!name||!type||!leistung||!geschlecht){
    playerMessageDiv.textContent="Bitte alle Felder ausfüllen!";
    playerMessageDiv.className='message error';
    return;
  }

  // Duplikatscheck
  if(adultPlayers.some(p=>p.Name.toLowerCase()===name.toLowerCase())||
     youthPlayers.some(p=>p.Name.toLowerCase()===name.toLowerCase())){
    playerMessageDiv.textContent="Ein Spieler mit diesem Namen existiert bereits.";
    playerMessageDiv.className='message error';
    return;
  }
  saveHistory();

  if(type==='adult'){
    adultPlayers.push({
      Name: name, 
      Position: position||'',
      Leistung: leistung,
      Geschlecht: geschlecht,
      Spiele:0,
      Punkte:0,
      MixedGames:0  // Wichtig: Startwert
    });
  } else {
    youthPlayers.push({
      Name: name,
      Leistung: leistung,
      Geschlecht: geschlecht,
      Spiele:0,
      Punkte:0
    });
  }
  playerMessageDiv.textContent=`${name} erfolgreich hinzugefügt.`;
  playerMessageDiv.className='message success';
  addPlayerForm.reset();
  renderPlayerList();
  updatePointsTable();
});

/* ------------------------------------------------------------
   Switch: Details
------------------------------------------------------------ */
toggleDetails.addEventListener('change',()=>{
  renderPlayerList();
  displayResults(adultTeams,mixedTeams);
});

/* ------------------------------------------------------------
   Sort-Funktionen (Tabelle)
   Wir machen asc/desc Switch
------------------------------------------------------------ */
document.querySelectorAll('#pointsTable thead th[data-sort]').forEach(th=>{
  th.addEventListener('click',function(){
    const criterion=th.getAttribute('data-sort'); 
    const currentDir=sortDirections[criterion];
    const newDir=(currentDir==='asc')?'desc':'asc';
    sortDirections[criterion]=newDir;
    sortPlayers(criterion,newDir);
  });
});

function sortPlayers(criterion,direction='asc'){
  const mul=(direction==='asc')?1:-1;
  if(criterion==='name'){
    adultPlayers.sort((a,b)=> a.Name.localeCompare(b.Name)*mul );
    youthPlayers.sort((a,b)=> a.Name.localeCompare(b.Name)*mul );
  } else if(criterion==='spiele'){
    adultPlayers.sort((a,b)=>(a.Spiele-b.Spiele)*mul);
    youthPlayers.sort((a,b)=>(a.Spiele-b.Spiele)*mul);
  } else if(criterion==='punkte'){
    adultPlayers.sort((a,b)=>(a.Punkte-b.Punkte)*mul);
    youthPlayers.sort((a,b)=>(a.Punkte-b.Punkte)*mul);
  }
  updatePointsTable();
}

/* ------------------------------------------------------------
   Zwei-Stufen-Priorisierung:
   1) Weniger Spiele zuerst
   2) Bei Gleichstand => Weniger MixedGames zuerst

   => sortAdultPlayersForRound()
------------------------------------------------------------ */
function sortAdultPlayersForRound(adults){
  // Sortierfunktion mit 2 Stufen
  adults.sort((a,b)=>{
    // Zuerst nach Spiele
    if(a.Spiele!==b.Spiele) {
      return a.Spiele - b.Spiele;
    }
    // Dann nach MixedGames
    if((a.MixedGames??0)!==(b.MixedGames??0)){
      return (a.MixedGames??0)-(b.MixedGames??0);
    }
    return 0;
  });
  return adults;
}

/* ------------------------------------------------------------
   Vorschau-Losen
------------------------------------------------------------ */
previewButton.addEventListener('click',()=>{
  const adultFields=parseInt(adultFieldsInput.value);
  const youthFields=parseInt(youthFieldsInput.value);
  const numberOfAdultTeams=adultFields*2;
  const numberOfMixedTeams=youthFields*2;

  const adultTeamSize=parseInt(adultTeamSizeInput.value);
  const adultPerMixedTeam=parseInt(adultPerMixedTeamInput.value);
  const youthPerMixedTeam=parseInt(youthPerMixedTeamInput.value);

  // Check ob genug Spieler ...
  const neededAdults=(numberOfAdultTeams*adultTeamSize)+(numberOfMixedTeams*adultPerMixedTeam);
  const neededYouth=(numberOfMixedTeams*youthPerMixedTeam);

  if(adultPlayers.length<neededAdults) {
    alert(`Nicht genug Erwachsene (${neededAdults} benötigt)!`);
    return;
  }
  if(youthPlayers.length<neededYouth) {
    alert(`Nicht genug Jugendliche (${neededYouth} benötigt)!`);
    return;
  }

  // => Zuerst adults sortieren mit 2 Stufen
  const sortedAdults= sortAdultPlayersForRound([...adultPlayers]); 
  // => Jugend nach Spiele (1 Stufe)
  const sortedYouth=[...youthPlayers].sort((a,b)=> a.Spiele - b.Spiele);

  const usedNames=new Set();

  // Erwachsenenteams
  let adultTeamPool=[];
  for(let i=0; i<sortedAdults.length; i++){
    if(adultTeamPool.length>=numberOfAdultTeams*adultTeamSize) break;
    const p=sortedAdults[i];
    if(!usedNames.has(p.Name)){
      usedNames.add(p.Name);
      adultTeamPool.push(p);
    }
  }

  // Adults in Mixed
  let adultsMixed=[];
  for(let i=0; i<sortedAdults.length; i++){
    if(adultsMixed.length>=numberOfMixedTeams*adultPerMixedTeam) break;
    const p=sortedAdults[i];
    if(!usedNames.has(p.Name)){
      usedNames.add(p.Name);
      adultsMixed.push(p);
    }
  }

  // Jugend in Mixed
  let youthMixed=[];
  for(let i=0; i<sortedYouth.length; i++){
    if(youthMixed.length>=numberOfMixedTeams*youthPerMixedTeam) break;
    const p=sortedYouth[i];
    if(!usedNames.has(p.Name)){
      usedNames.add(p.Name);
      youthMixed.push(p);
    }
  }

  previewAdultTeams=[];
  for(let i=0; i<numberOfAdultTeams; i++){
    const start=i*adultTeamSize;
    const end=(i+1)*adultTeamSize;
    previewAdultTeams.push(adultTeamPool.slice(start,end));
  }

  previewMixedTeams=[];
  for(let i=0; i<numberOfMixedTeams; i++){
    const adultSlice=adultsMixed.slice(i*adultPerMixedTeam,(i+1)*adultPerMixedTeam);
    const youthSlice=youthMixed.slice(i*youthPerMixedTeam,(i+1)*youthPerMixedTeam);
    previewMixedTeams.push([...adultSlice,...youthSlice]);
  }

  showFeedbackModal(previewAdultTeams, previewMixedTeams);
  applyPreviewButton.disabled=false;
});

/* Teams übernehmen */
applyPreviewButton.addEventListener('click',function(){
  adultTeams=JSON.parse(JSON.stringify(previewAdultTeams));
  mixedTeams=JSON.parse(JSON.stringify(previewMixedTeams));
  displayResults(adultTeams,mixedTeams);
  this.disabled=true;
});

/* ------------------------------------------------------------
   Ergebnisse Anzeigen
------------------------------------------------------------ */
function displayResults(aTeams,mTeams){
  resultsSection.style.display='block';
  adultTeamsListDiv.innerHTML='';
  mixedTeamsListDiv.innerHTML='';

  const showDetails=toggleDetails.checked;

  aTeams.forEach((team,i)=>{
    const div=document.createElement('div');
    div.className='team-item';
    const names=team.map(p=>formatNameForTeamDisplay(p,showDetails)).join(', ');
    div.innerHTML=`<strong>Erwachsenenteam ${i+1}:</strong> ${names}`;
    adultTeamsListDiv.appendChild(div);
  });

  mTeams.forEach((team,i)=>{
    const div=document.createElement('div');
    div.className='team-item';
    const names=team.map(p=>formatNameForTeamDisplay(p,showDetails)).join(', ');
    div.innerHTML=`<strong>Team Jugend ${i+1}:</strong> ${names}`;
    mixedTeamsListDiv.appendChild(div);
  });

  createMatches(aTeams,mTeams);
  updatePointsTable();
}

function formatNameForTeamDisplay(player,showDetails){
  if(!showDetails){
    // nur Vorname + 1. Buchstabe
    const parts=player.Name.split(' ');
    if(parts.length>1){
      return parts[0]+' '+parts[1].charAt(0)+'.';
    } else {
      return parts[0];
    }
  }
  // alles
  const pos=player.Position?`Pos:${player.Position}, `:'';
  const lei=player.Leitung?`L:${player.Leitung}, `:'';
  const gen=player.Geschlecht?`G:${player.Geschlecht}, `:'';
  const mix=(player.MixedGames!==undefined)?`Mixed:${player.MixedGames}`:'';
  return `${player.Name} (${pos}${lei}${gen}${mix})`;
}

/* ------------------------------------------------------------
   Matches
   -> recordMatchResult prüft: 
      Wenn "mixed", für alle erwachsenen Spieler MixedGames++
------------------------------------------------------------ */
function createMatches(aTeams,mTeams){
  adultMatchesDiv.innerHTML='';
  mixedMatchesDiv.innerHTML='';

  for(let i=0; i<aTeams.length; i+=2){
    if(i+1<aTeams.length){
      const matchDiv=document.createElement('div');
      matchDiv.className='match-item';
      matchDiv.innerHTML=`
        <strong>Feld ${Math.floor(i/2)+1}:</strong> 
        Erwachsenenteam ${i+1} gegen Erwachsenenteam ${i+2}
        <button class="button" data-match-type="adult" data-winning-team="${i}">
          Gewinner: Team ${i+1}
        </button>
        <button class="button" data-match-type="adult" data-winning-team="${i+1}">
          Gewinner: Team ${i+2}
        </button>
      `;
      adultMatchesDiv.appendChild(matchDiv);
    }
  }

  for(let i=0; i<mTeams.length; i+=2){
    if(i+1<mTeams.length){
      const matchDiv=document.createElement('div');
      matchDiv.className='match-item';
      matchDiv.innerHTML=`
        <strong>Gemischtes Feld ${Math.floor(i/2)+1}:</strong> 
        Team Jugend ${i+1} gegen Team Jugend ${i+2}
        <button class="button" data-match-type="mixed" data-winning-team="${i}">
          Gewinner: Team ${i+1}
        </button>
        <button class="button" data-match-type="mixed" data-winning-team="${i+1}">
          Gewinner: Team ${i+2}
        </button>
      `;
      mixedMatchesDiv.appendChild(matchDiv);
    }
  }

  const buttons=document.querySelectorAll('.match-item .button');
  buttons.forEach(btn=>{
    btn.addEventListener('click',function(){
      const matchType=this.getAttribute('data-match-type');
      const winningTeamIndex=parseInt(this.getAttribute('data-winning-team'));
      recordMatchResult(matchType,winningTeamIndex);
      this.parentNode.querySelectorAll('.button').forEach(b=>b.disabled=true);
    });
  });
}

function recordMatchResult(matchType,winningTeamIndex){
  let winningTeam=[];
  let losingTeam=[];

  if(matchType==='adult'){
    winningTeam=adultTeams[winningTeamIndex];
    const opp=(winningTeamIndex%2===0)?winningTeamIndex+1:winningTeamIndex-1;
    losingTeam=adultTeams[opp];
  } else {
    // Mixed
    winningTeam=mixedTeams[winningTeamIndex];
    const opp=(winningTeamIndex%2===0)?winningTeamIndex+1:winningTeamIndex-1;
    losingTeam=mixedTeams[opp];

    // -> Im Mixed-Team: MixedGames++ für alle Erwachsenen
    winningTeam.forEach(player=>{
      const real=findPlayerByName(player.Name);
      if(real && isAdult(real)) {
        real.MixedGames=(real.MixedGames??0)+1;
      }
    });
    losingTeam.forEach(player=>{
      const real=findPlayerByName(player.Name);
      if(real && isAdult(real)) {
        real.MixedGames=(real.MixedGames??0)+1;
      }
    });
  }

  // Punkte+Spiele
  winningTeam.forEach(player=>{
    const real=findPlayerByName(player.Name);
    if(real){
      real.Punkte++;
      real.Spiele++;
    }
  });
  losingTeam.forEach(player=>{
    const real=findPlayerByName(player.Name);
    if(real){
      real.Spiele++;
    }
  });

  alert(`Team ${winningTeamIndex+1} hat gewonnen!`);
  updatePointsTable();
}

// Hilfsfunktion, um Erwachsen vs. Jugend zu unterscheiden
function isAdult(p){
  return adultPlayers.some(a=>a.Name===p.Name);
}

function findPlayerByName(name){
  let p=adultPlayers.find(pl=>pl.Name===name);
  if(p) return p;
  p=youthPlayers.find(pl=>pl.Name===name);
  return p;
}

/* ------------------------------------------------------------
   Punkte-Tabelle
------------------------------------------------------------ */
function updatePointsTable(){
  pointsTableBody.innerHTML='';

  // Erwachsene
  adultPlayers.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.classList.add('adult-player');
    tr.innerHTML=`
      <td>${p.Name}</td>
      <td>${p.Spiele}</td>
      <td>${p.Punkte}</td>
      <td>
        <button class="adjust-button" onclick="adjustPoints('adult', ${i}, 1)">+Punkt</button>
        <button class="adjust-button" onclick="adjustPoints('adult', ${i}, -1)">-Punkt</button>
        <button class="adjust-button" onclick="adjustGames('adult', ${i}, 1)">+Spiel</button>
        <button class="adjust-button" onclick="adjustGames('adult', ${i}, -1)">-Spiel</button>
      </td>
    `;
    pointsTableBody.appendChild(tr);
  });

  // Jugend
  youthPlayers.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.classList.add('youth-player');
    tr.innerHTML=`
      <td>${p.Name}</td>
      <td>${p.Spiele}</td>
      <td>${p.Punkte}</td>
      <td>
        <button class="adjust-button" onclick="adjustPoints('youth', ${i}, 1)">+Punkt</button>
        <button class="adjust-button" onclick="adjustPoints('youth', ${i}, -1)">-Punkt</button>
        <button class="adjust-button" onclick="adjustGames('youth', ${i}, 1)">+Spiel</button>
        <button class="adjust-button" onclick="adjustGames('youth', ${i}, -1)">-Spiel</button>
      </td>
    `;
    pointsTableBody.appendChild(tr);
  });
}

window.adjustPoints=function(type,index,delta){
  if(type==='adult'){
    const p=adultPlayers[index];
    if(delta<0 && p.Punkte<=0){
      alert("Punkte können nicht negativ werden!");
      return;
    }
    p.Punkte+=delta;
  } else {
    const p=youthPlayers[index];
    if(delta<0 && p.Punkte<=0){
      alert("Punkte können nicht negativ werden!");
      return;
    }
    p.Punkte+=delta;
  }
  updatePointsTable();
};

window.adjustGames=function(type,index,delta){
  if(type==='adult'){
    const p=adultPlayers[index];
    if(delta<0 && p.Spiele<=0){
      alert("Spiele können nicht negativ werden!");
      return;
    }
    p.Spiele+=delta;
  } else {
    const p=youthPlayers[index];
    if(delta<0 && p.Spiele<=0){
      alert("Spiele können nicht negativ werden!");
      return;
    }
    p.Spiele+=delta;
  }
  updatePointsTable();
};

/* ------------------------------------------------------------
   Modal / CSV
------------------------------------------------------------ */
function showFeedbackModal(aTeams,mTeams){
  const modal=document.getElementById('feedbackModal');
  const span=document.getElementsByClassName('close')[0];
  const feedbackContent=document.getElementById('feedbackContent');

  let html=`<h3>Erwachsenenteams (Vorschau):</h3>`;
  aTeams.forEach((team,idx)=>{
    const names=team.map(p=>p.Name).join(', ');
    html+=`<p><strong>Team ${idx+1}:</strong> ${names}</p>`;
  });
  html+=`<h3>Gemischte Teams (Vorschau):</h3>`;
  mTeams.forEach((team,idx)=>{
    const names=team.map(p=>p.Name).join(', ');
    html+=`<p><strong>Team Jugend ${idx+1}:</strong> ${names}</p>`;
  });
  feedbackContent.innerHTML=html;
  modal.style.display='block';

  span.onclick=()=>modal.style.display='none';
  window.onclick=(e)=>{
    if(e.target===modal) modal.style.display='none';
  };
}

exportButton.addEventListener('click',()=>{
  const csvContent=generateCSV();
  downloadCSV(csvContent,'spielergebnisse.csv');
});
function generateCSV(){
  let csv='Name,Spiele,Punkte,MixedGames\n';
  adultPlayers.forEach(p=>{
    csv+=`"${p.Name}",${p.Spiele},${p.Punkte},${p.MixedGames??0}\n`;
  });
  youthPlayers.forEach(p=>{
    // Jugend hat kein MixedGames
    csv+=`"${p.Name}",${p.Spiele},${p.Punkte},-\n`;
  });
  return csv;
}
function downloadCSV(csvContent, filename){
  const blob=new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
  if(navigator.msSaveBlob){
    navigator.msSaveBlob(blob,filename);
  } else {
    const link=document.createElement('a');
    if(link.download!==undefined){
      const url=URL.createObjectURL(blob);
      link.setAttribute('href',url);
      link.setAttribute('download',filename);
      link.style.visibility='hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  }
}

/* ------------------------------------------------------------
   onload
------------------------------------------------------------ */
window.onload=function(){
  loadData();
  renderPlayerList();
  updatePointsTable();
  if(adultTeams.length>0 || mixedTeams.length>0){
    displayResults(adultTeams,mixedTeams);
  }
};
</script>

</body>
</html>
