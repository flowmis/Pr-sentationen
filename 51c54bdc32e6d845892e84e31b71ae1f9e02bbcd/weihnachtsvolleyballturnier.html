<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Volleyball Turnier Losgenerator (Erweitert)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
    }
    h1, h2, h3, h4 {
      margin-top: 40px;
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      margin-bottom: 20px;
      background-color: #fff;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #4CAF50;
      color: white;
      cursor: pointer; /* Damit man sieht, dass man klicken kann, wenn man sortieren will */
    }
    .player-list, .team-list, .matches-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #aaa;
      padding: 10px;
      margin-top: 10px;
      background-color: #fff;
    }
    .player-item, .team-item, .match-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
      padding: 5px;
      border-bottom: 1px solid #ddd;
    }
    .add-player-form input, .add-player-form select, .add-player-form button {
      margin-right: 10px;
      padding: 5px;
      font-size: 14px;
    }
    .section {
      margin-bottom: 40px;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .button {
      padding: 8px 16px;
      background-color: #28a745;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
      margin-left: 5px;
      transition: background-color 0.3s;
    }
    .button:hover {
      background-color: #218838;
    }
    .message {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
    }
    .adjust-button {
      padding: 4px 8px;
      background-color: #007bff;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 12px;
      border-radius: 4px;
      margin-left: 5px;
      transition: background-color 0.3s;
    }
    .adjust-button:hover {
      background-color: #0069d9;
    }
    .button:disabled, .adjust-button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    .modal {
      display: none; 
      position: fixed; 
      z-index: 999; 
      padding-top: 100px; 
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      border-radius: 8px;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover,
    .close:focus {
      color: black;
    }
    .export-button {
      background-color: #17a2b8;
    }
    .export-button:hover {
      background-color: #138496;
    }

    /* Größere Darstellung für Teams */
    .team-item {
      font-size: 1.2rem;
    }

    /* Farbliche Kennzeichnung (optional) */
    /* Hellrot für Erwachsene, Hellblau für Jugend */
    .adult-player {
      background-color: #ffe8e8;
    }
    .youth-player {
      background-color: #e8f7ff;
    }
  </style>
</head>
<body>

<h1>Volleyball Turnier Losgenerator (Erweitert)</h1>

<button id="undoButton" class="button" style="background-color:#6c757d;">Rückgängig</button>

<div class="section">
  <h2>Spieler</h2>
  <div id="playerList" class="player-list"></div>
  
  <h3>Spieler hinzufügen</h3>
  <form id="addPlayerForm" class="add-player-form">
    <input type="text" id="playerName" placeholder="Name" required>
    <select id="playerType" required>
      <option value="" disabled selected>Erwachsen/Jugend</option>
      <option value="adult">Erwachsene/r</option>
      <option value="youth">Jugend</option>
    </select>
    <select id="playerPosition">
      <option value="" disabled selected>Position (nur Erwachsene)</option>
      <option value="MB">MB</option>
      <option value="AA">AA</option>
      <option value="Z">Z</option>
    </select>
    <select id="playerLeistung" required>
      <option value="" disabled selected>Leistung</option>
      <option value="1">1 - Sehr gut</option>
      <option value="2">2 - Gut</option>
      <option value="3">3 - Weniger gut</option>
    </select>
    <select id="playerGeschlecht" required>
      <option value="" disabled selected>Geschlecht</option>
      <option value="M">Männlich</option>
      <option value="F">Weiblich</option>
    </select>
    <button type="submit" class="button">Hinzufügen</button>
  </form>
  <div id="playerMessage" class="message"></div>
</div>

<!-- Teams Losen -->
<div class="section">
  <h2>Teams Losen</h2>

  <!-- Checkboxen -->
  <div>
    <label><input type="checkbox" id="useLeistung" checked>Nach Leistung berücksichtigen?</label>
    <label style="margin-left:20px;"><input type="checkbox" id="useGeschlecht" checked>Nach Geschlecht berücksichtigen?</label>
    <label style="margin-left:20px;"><input type="checkbox" id="usePosition" checked>Nach Position berücksichtigen?</label>
  </div>

  <div style="margin-top:20px;">
    <label>Anzahl der Erwachsenenfelder:</label>
    <input type="number" id="adultFields" value="3" style="width: 50px;">
    <label style="margin-left:20px;">Anzahl der Jugendfelder:</label>
    <input type="number" id="youthFields" value="3" style="width: 50px;">
  </div>

  <div style="margin-top:20px;">
    <label>Erwachsene pro Erwachsenen-Team:</label>
    <input type="number" id="adultTeamSize" value="6" min="1" style="width: 50px;">
  </div>
  <div style="margin-top:20px;">
    <label>Erwachsene pro Team Jugend:</label>
    <input type="number" id="adultPerMixedTeam" value="1" min="1" style="width: 50px;">
  </div>
  <div style="margin-top:20px;">
    <label>Jugendspieler pro Team Jugend:</label>
    <input type="number" id="youthPerMixedTeam" value="2" min="1" style="width: 50px;">
  </div>

  <button id="previewButton" class="button" style="margin-top:20px;">Vorschau Losen</button>
  <button id="applyPreviewButton" class="button" disabled>Anwenden</button>
  <button id="exportButton" class="button export-button">Ergebnisse Exportieren</button>

  <div id="unassignedPlayersSection" class="section" style="display:none;">
    <h3>Nicht zugeteilte Spieler</h3>
    <div id="unassignedAdults" class="player-list"><h4>Erwachsene</h4></div>
    <div id="unassignedYouth" class="player-list"><h4>Jugendspieler</h4></div>
  </div>
</div>

<!-- Ergebnisse -->
<div class="section" id="resultsSection" style="display:none;">
  <h2>Ergebnisse</h2>

  <!-- Sortierhinweis: Klick auf Spaltenüberschriften -->
  <p><strong>Tipp:</strong> Klicke auf <em>Name</em>, <em>Spiele</em> oder <em>Punkte</em>, um danach zu sortieren.</p>

  <h3>Erwachsenenteams</h3>
  <div id="adultTeamsList" class="team-list"></div>
  <h3>Gemischte Teams</h3>
  <div id="mixedTeamsList" class="team-list"></div>

  <h3>Paarungen</h3>
  <div id="matchesList" class="team-list">
    <h4>Erwachsenen Matches</h4>
    <div id="adultMatches"></div>
    <h4>Gemischte Matches</h4>
    <div id="mixedMatches"></div>
  </div>

  <h3>Spielergebnisse und Punkte</h3>
  <!-- data-sort="..." für Klick-Sortierung -->
  <table id="pointsTable">
    <thead>
      <tr>
        <th data-sort="name">Name</th>
        <th data-sort="spiele">Spiele</th>
        <th data-sort="punkte">Punkte</th>
        <th>Aktionen</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Feedback Modal -->
<div id="feedbackModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Vorschau der Teams</h2>
    <div id="feedbackContent"></div>
  </div>
</div>

<script>
/* ---------------------------------------------
   1) Globale Variablen
--------------------------------------------- */
let adultPlayers = [
  { Name: "Alex K.", Position: "MB", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Leon K.", Position: "MB", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Franzi K.", Position: "AA", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Monja B.", Position: "MB", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Ali K.", Position: "Z", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Anna R.", Position: "AA", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Ben B.", Position: "MB", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Caro S.", Position: "MB", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Daniel E.", Position: "AA", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Daria A.", Position: "AA", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Elias K.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Elias S.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Emily K.", Position: "AA", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Fabian D.", Position: "MB", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Felina S.", Position: "AA", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Felix K.", Position: "AA", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Karrrrle", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Florian B.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Helene M.", Position: "AA", Leistung: "3", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Helene Maneth", Position: "AA", Leistung: "3", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Ida B.", Position: "MB", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Jan K.", Position: "MB", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Jannis E.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Jannis H.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Jannis W.", Position: "MB", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Joel D.", Position: "AA", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Johanna S.", Position: "MB", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Flo R.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Chris K.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Lauresa O.", Position: "AA", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Hannah B.", Position: "AA", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },

  { Name: "Jonas Labisch", Position: "Z", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Paul L.", Position: "Z", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Jonas Lingel.", Position: "Z", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Julian S.", Position: "AA", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Katharina B.", Position: "AA", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Katja H.", Position: "Z", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Lara K.", Position: "MB", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Leah B.", Position: "AA", Leistung: "3", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Marus H.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Lenard S.", Position: "Z", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Leni J.", Position: "AA", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Leo B.", Position: "AA", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Lina M.", Position: "AA", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Linus W.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Lucie N.", Position: "AA", Leistung: "3", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Martin U.", Position: "Z", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Max D.", Position: "AA", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Michi H.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Mieke K.", Position: "AA", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Nelly A.", Position: "MB", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Nicklas K.", Position: "MB", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Nikita S.", Position: "AA", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Patrick S.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Philipp K.", Position: "Z", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Pius M.", Position: "Z", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Robin W.", Position: "Z", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Ronja B.", Position: "AA", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Rune D.", Position: "Z", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Sara T.", Position: "Z", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Niko K.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Ludo N.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Sebastian M.", Position: "AA", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Steffi G.", Position: "Z", Leistung: "1", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Tom W.", Position: "AA", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Vica M.", Position: "Z", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 }
];

let youthPlayers = [
  { Name: "Noah E.", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Frieda M.", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Julia E.", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Elena C.", Leistung: "3", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Noemi R.", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Mirjam K.", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Jakob K.", Leistung: "3", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Bennett G.", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Annelie M.", Leistung: "3", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Alex Z.", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Laurenz J.", Leistung: "2", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "David S.", Leistung: "1", Geschlecht: "M", Spiele: 0, Punkte: 0 },
  { Name: "Elya M.", Leistung: "3", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Emilia Hauf.", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 },
  { Name: "Leila O.", Leistung: "2", Geschlecht: "F", Spiele: 0, Punkte: 0 }
];

// Arrays für unassigned
let unassignedAdultsGlobal = [];
let unassignedYouthGlobal = [];

// Teams
let adultTeams = [];
let mixedTeams = [];

// Preview
let previewAdultTeams = [];
let previewMixedTeams = [];

// Undo
let historyStack = [];

/* ---------------------------------------------
   2) DOM-Referenzen
--------------------------------------------- */
const playerListDiv = document.getElementById('playerList');
const addPlayerForm = document.getElementById('addPlayerForm');
const playerMessageDiv = document.getElementById('playerMessage');

const unassignedPlayersSection = document.getElementById('unassignedPlayersSection');
const unassignedAdultsDiv = document.getElementById('unassignedAdults');
const unassignedYouthDiv = document.getElementById('unassignedYouth');

const resultsSection = document.getElementById('resultsSection');
const adultTeamsListDiv = document.getElementById('adultTeamsList');
const mixedTeamsListDiv = document.getElementById('mixedTeamsList');
const adultMatchesDiv = document.getElementById('adultMatches');
const mixedMatchesDiv = document.getElementById('mixedMatches');
const pointsTableBody = document.querySelector('#pointsTable tbody');

const undoButton = document.getElementById('undoButton');
const previewButton = document.getElementById('previewButton');
const applyPreviewButton = document.getElementById('applyPreviewButton');
const exportButton = document.getElementById('exportButton');

const adultFieldsInput = document.getElementById('adultFields');
const youthFieldsInput = document.getElementById('youthFields');
const adultTeamSizeInput = document.getElementById('adultTeamSize');
const adultPerMixedTeamInput = document.getElementById('adultPerMixedTeam');
const youthPerMixedTeamInput = document.getElementById('youthPerMixedTeam');

/* ---------------------------------------------
   3) Daten Laden / Speichern
--------------------------------------------- */
function loadData() {
  const savedAdults = localStorage.getItem('adultPlayers');
  const savedYouth = localStorage.getItem('youthPlayers');
  const savedAdultTeams = localStorage.getItem('adultTeams');
  const savedMixedTeams = localStorage.getItem('mixedTeams');
  const savedPoints = localStorage.getItem('points');
  const savedUnassignedAdults = localStorage.getItem('unassignedAdultsGlobal');
  const savedUnassignedYouth = localStorage.getItem('unassignedYouthGlobal');

  if (savedAdults) adultPlayers = JSON.parse(savedAdults);
  if (savedYouth) youthPlayers = JSON.parse(savedYouth);
  if (savedAdultTeams) adultTeams = JSON.parse(savedAdultTeams);
  if (savedMixedTeams) mixedTeams = JSON.parse(savedMixedTeams);

  if (savedPoints) {
    const pointsData = JSON.parse(savedPoints);
    adultPlayers.forEach((p, i) => {
      if (pointsData.adultPlayers[i]) {
        p.Spiele = pointsData.adultPlayers[i].Spiele;
        p.Punkte = pointsData.adultPlayers[i].Punkte;
      }
    });
    youthPlayers.forEach((p, i) => {
      if (pointsData.youthPlayers[i]) {
        p.Spiele = pointsData.youthPlayers[i].Spiele;
        p.Punkte = pointsData.youthPlayers[i].Punkte;
      }
    });
  }

  if (savedUnassignedAdults) unassignedAdultsGlobal = JSON.parse(savedUnassignedAdults);
  if (savedUnassignedYouth) unassignedYouthGlobal = JSON.parse(savedUnassignedYouth);
}

function saveData() {
  localStorage.setItem('adultPlayers', JSON.stringify(adultPlayers));
  localStorage.setItem('youthPlayers', JSON.stringify(youthPlayers));
  localStorage.setItem('adultTeams', JSON.stringify(adultTeams));
  localStorage.setItem('mixedTeams', JSON.stringify(mixedTeams));

  const pointsData = {
    adultPlayers: adultPlayers.map(p => ({ Spiele: p.Spiele, Punkte: p.Punkte })),
    youthPlayers: youthPlayers.map(p => ({ Spiele: p.Spiele, Punkte: p.Punkte }))
  };
  localStorage.setItem('points', JSON.stringify(pointsData));

  localStorage.setItem('unassignedAdultsGlobal', JSON.stringify(unassignedAdultsGlobal));
  localStorage.setItem('unassignedYouthGlobal', JSON.stringify(unassignedYouthGlobal));
}

/* ---------------------------------------------
   4) Undo-Funktion
--------------------------------------------- */
function saveHistory() {
  historyStack.push({
    adultPlayers: JSON.parse(JSON.stringify(adultPlayers)),
    youthPlayers: JSON.parse(JSON.stringify(youthPlayers))
  });
}

function undoLastChange() {
  if (historyStack.length > 0) {
    const lastState = historyStack.pop();
    adultPlayers = lastState.adultPlayers;
    youthPlayers = lastState.youthPlayers;
    saveData();
    renderPlayerList();
    updatePointsTable();
  } else {
    alert("Keine Änderung zum Rückgängig machen.");
  }
}
undoButton.addEventListener('click', undoLastChange);

/* ---------------------------------------------
   5) Spieler-Listen Rendering
--------------------------------------------- */
function renderPlayerList() {
  playerListDiv.innerHTML = '';

  // Erwachsene
  adultPlayers.forEach((player, index) => {
    const div = document.createElement('div');
    div.className = 'player-item adult-player'; // farbliche Hervorhebung
    div.innerHTML = `
      <span>[Erw.] ${player.Name} (Pos: ${player.Position || "n/a"}, L: ${player.Leitung}, G: ${player.Geschlecht})</span>
      <div>
        <button class="button" onclick="editAdultPlayer(${index})">Bearbeiten</button>
        <button class="button" onclick="deleteAdultPlayer(${index})">Löschen</button>
      </div>
    `;
    playerListDiv.appendChild(div);
  });

  // Jugend
  youthPlayers.forEach((player, index) => {
    const div = document.createElement('div');
    div.className = 'player-item youth-player'; // farbliche Hervorhebung
    div.innerHTML = `
      <span>[Jug.] ${player.Name} (L: ${player.Leitung}, G: ${player.Geschlecht})</span>
      <div>
        <button class="button" onclick="editYouthPlayer(${index})">Bearbeiten</button>
        <button class="button" onclick="deleteYouthPlayer(${index})">Löschen</button>
      </div>
    `;
    playerListDiv.appendChild(div);
  });
}

/* Edit-Funktionen */
window.editAdultPlayer = function(index) {
  const player = adultPlayers[index];
  const newName = prompt("Neuen Namen eingeben:", player.Name);
  if (newName && newName.trim() !== "") {
    saveHistory();
    player.Name = newName.trim();
    saveData();
    renderPlayerList();
    updatePointsTable();
  }
};

window.editYouthPlayer = function(index) {
  const player = youthPlayers[index];
  const newName = prompt("Neuen Namen eingeben:", player.Name);
  if (newName && newName.trim() !== "") {
    saveHistory();
    player.Name = newName.trim();
    saveData();
    renderPlayerList();
    updatePointsTable();
  }
};

/* Delete-Funktionen */
window.deleteAdultPlayer = function(index) {
  if(confirm(`Möchten Sie ${adultPlayers[index].Name} wirklich löschen?`)){
    saveHistory();
    adultPlayers.splice(index, 1);
    saveData();
    renderPlayerList();
    updatePointsTable();
  }
};

window.deleteYouthPlayer = function(index) {
  if(confirm(`Möchten Sie ${youthPlayers[index].Name} wirklich löschen?`)){
    saveHistory();
    youthPlayers.splice(index, 1);
    saveData();
    renderPlayerList();
    updatePointsTable();
  }
};

/* ---------------------------------------------
   6) Spieler Hinzufügen
--------------------------------------------- */
addPlayerForm.addEventListener('submit', function(e) {
  e.preventDefault();
  const name = document.getElementById('playerName').value.trim();
  const type = document.getElementById('playerType').value;
  const position = document.getElementById('playerPosition').value;
  const leistung = document.getElementById('playerLeistung').value;
  const geschlecht = document.getElementById('playerGeschlecht').value;

  if(!name || !type || !leistung || !geschlecht){
    playerMessageDiv.textContent = "Bitte alle Felder ausfüllen!";
    playerMessageDiv.className = 'message error';
    return;
  }

  // Duplikatscheck
  if(adultPlayers.some(p => p.Name.toLowerCase() === name.toLowerCase()) ||
     youthPlayers.some(p => p.Name.toLowerCase() === name.toLowerCase())) {
    playerMessageDiv.textContent = "Ein Spieler mit diesem Namen existiert bereits.";
    playerMessageDiv.className = 'message error';
    return;
  }

  saveHistory();
  if(type === 'adult') {
    adultPlayers.push({
      Name: name,
      Position: position || "",
      Leistung: leistung,
      Geschlecht: geschlecht,
      Spiele: 0,
      Punkte: 0
    });
  } else {
    youthPlayers.push({
      Name: name,
      Leistung: leistung,
      Geschlecht: geschlecht,
      Spiele: 0,
      Punkte: 0
    });
  }

  addPlayerForm.reset();
  playerMessageDiv.textContent = `${name} erfolgreich hinzugefügt.`;
  playerMessageDiv.className = 'message success';

  saveData();
  renderPlayerList();
  updatePointsTable();
});

/* ---------------------------------------------
   7) Sort-Funktionen (per Klick auf <th>)
--------------------------------------------- */
document.querySelectorAll('#pointsTable thead th[data-sort]').forEach(th => {
  th.addEventListener('click', function() {
    const criterion = th.getAttribute('data-sort'); // "name", "spiele" oder "punkte"
    sortPlayers(criterion);
  });
});

function sortPlayers(criterion) {
  if (criterion === 'name') {
    adultPlayers.sort((a,b) => a.Name.localeCompare(b.Name));
    youthPlayers.sort((a,b) => a.Name.localeCompare(b.Name));
  } else if (criterion === 'spiele') {
    adultPlayers.sort((a,b) => a.Spiele - b.Spiele);
    youthPlayers.sort((a,b) => a.Spiele - b.Spiele);
  } else if (criterion === 'punkte') {
    adultPlayers.sort((a,b) => a.Punkte - b.Punkte);
    youthPlayers.sort((a,b) => a.Punkte - b.Punkte);
  }
  updatePointsTable();
}

/* ---------------------------------------------
   8) Zuweisungs-Logik
--------------------------------------------- */
function getAllPlayersForRound() {
  // Unassigned zuerst
  const filteredAdults = adultPlayers.filter(
    p => !unassignedAdultsGlobal.some(u => u.Name === p.Name)
  );
  const allAdultPlayers = [...unassignedAdultsGlobal, ...filteredAdults];

  const filteredYouth = youthPlayers.filter(
    p => !unassignedYouthGlobal.some(u => u.Name === p.Name)
  );
  const allYouthPlayers = [...unassignedYouthGlobal, ...filteredYouth];

  // Sortieren nach "Spiele" aufsteigend (Priorität: weniger Spiele)
  allAdultPlayers.sort((a,b) => a.Spiele - b.Spiele);
  allYouthPlayers.sort((a,b) => a.Spiele - b.Spiele);

  return { allAdultPlayers, allYouthPlayers };
}

function isAlreadyUsed(player, usedNamesSet) {
  return usedNamesSet.has(player.Name);
}

// Zuteilung ohne Geschlechts-/Positions-/Leistungs-Kriterien
function assignWithoutCriteria(players, numberOfTeams, teamSize, usedNames) {
  const assignedPlayers = [];
  for(let i=0; i<players.length; i++){
    if(assignedPlayers.length >= numberOfTeams*teamSize) {
      break;
    }
    const p = players[i];
    if(!isAlreadyUsed(p, usedNames)) {
      assignedPlayers.push(p);
      usedNames.add(p.Name);
    }
  }
  return assignedPlayers;
}

// Zuteilung mit möglichen Kriterien
function assignWithCriteria(players, useGeschlecht, usePosition, useLeistung,
                            numberOfTeams, teamSize, usedNames) {
  let sorted = [...players];

  let group1 = [];
  let group2 = [];

  if(useGeschlecht) {
    group1 = sorted.filter(p => p.Geschlecht === 'M');
    group2 = sorted.filter(p => p.Geschlecht === 'F');
  } else {
    group1 = sorted;
  }

  // Falls du Position oder Leistung noch genauer aufsplitten möchtest,
  // kannst du hier mehr Logik ergänzen.

  const assigned = [];
  for(let i=0; i< numberOfTeams; i++){
    for(let j=0; j<teamSize; j++){
      let candidate = null;
      if(j%2===0 && group1.length>0) {
        candidate = group1.find(p => !usedNames.has(p.Name));
        if(candidate) {
          assigned.push(candidate);
          usedNames.add(candidate.Name);
          group1.splice(group1.indexOf(candidate),1);
        }
      } else if(group2.length>0) {
        candidate = group2.find(p => !usedNames.has(p.Name));
        if(candidate){
          assigned.push(candidate);
          usedNames.add(candidate.Name);
          group2.splice(group2.indexOf(candidate),1);
        }
      }
    }
  }

  return assigned;
}

/* ---------------------------------------------
   9) Vorschau-Losen
--------------------------------------------- */
previewButton.addEventListener('click', function() {
  const adultFields = parseInt(adultFieldsInput.value);
  const youthFields = parseInt(youthFieldsInput.value);
  const numberOfAdultTeams = adultFields * 2;
  const numberOfMixedTeams = youthFields * 2;

  const adultTeamSize = parseInt(adultTeamSizeInput.value);
  const adultPerMixedTeam = parseInt(adultPerMixedTeamInput.value);
  const youthPerMixedTeam = parseInt(youthPerMixedTeamInput.value);

  if(isNaN(adultFields) || adultFields<1 ||
     isNaN(youthFields) || youthFields<1 ||
     isNaN(adultTeamSize) || adultTeamSize<1 ||
     isNaN(adultPerMixedTeam) || adultPerMixedTeam<1 ||
     isNaN(youthPerMixedTeam) || youthPerMixedTeam<1)
  {
    alert("Bitte gültige Werte eingeben!");
    return;
  }

  const neededAdults = numberOfAdultTeams*adultTeamSize + numberOfMixedTeams*adultPerMixedTeam;
  const neededYouth = numberOfMixedTeams*youthPerMixedTeam;

  const allAvailableAdults = adultPlayers.length + unassignedAdultsGlobal.length;
  const allAvailableYouth = youthPlayers.length + unassignedYouthGlobal.length;

  if(allAvailableAdults < neededAdults) {
    alert(`Es werden ${neededAdults} Erwachsene benötigt!`);
    return;
  }
  if(allAvailableYouth < neededYouth) {
    alert(`Es werden ${neededYouth} Jugendspieler benötigt!`);
    return;
  }

  const useLeistung = document.getElementById('useLeistung').checked;
  const useGeschlecht = document.getElementById('useGeschlecht').checked;
  const usePosition = document.getElementById('usePosition').checked;

  const { allAdultPlayers, allYouthPlayers } = getAllPlayersForRound();
  const usedNames = new Set();

  // Erwachsene in Erwachsenenteams
  let adultTeamPool = [];
  if(!useLeistung && !useGeschlecht && !usePosition) {
    shuffle(allAdultPlayers);
    adultTeamPool = assignWithoutCriteria(allAdultPlayers, numberOfAdultTeams, adultTeamSize, usedNames);
  } else {
    adultTeamPool = assignWithCriteria(
      allAdultPlayers, useGeschlecht, usePosition, useLeistung,
      numberOfAdultTeams, adultTeamSize, usedNames
    );
  }

  // Erwachsene in Mixed
  let adultsForMixed = [];
  if(!useLeistung && !useGeschlecht && !usePosition) {
    shuffle(allAdultPlayers);
    adultsForMixed = assignWithoutCriteria(allAdultPlayers, numberOfMixedTeams, adultPerMixedTeam, usedNames);
  } else {
    adultsForMixed = assignWithCriteria(
      allAdultPlayers, useGeschlecht, usePosition, useLeistung,
      numberOfMixedTeams, adultPerMixedTeam, usedNames
    );
  }

  // Jugend
  let youthForMixed = [];
  if(!useLeistung && !useGeschlecht) {
    shuffle(allYouthPlayers);
    youthForMixed = assignWithoutCriteria(allYouthPlayers, numberOfMixedTeams, youthPerMixedTeam, usedNames);
  } else {
    if(useGeschlecht) {
      const males = allYouthPlayers.filter(p => p.Geschlecht==='M' && !usedNames.has(p.Name));
      const females = allYouthPlayers.filter(p => p.Geschlecht==='F' && !usedNames.has(p.Name));
      youthForMixed = [];
      for(let i=0; i<numberOfMixedTeams; i++){
        for(let j=0; j<youthPerMixedTeam; j++){
          let candidate = null;
          if(j%2===0 && males.length>0){
            candidate = males.shift();
          } else if(females.length>0){
            candidate = females.shift();
          }
          if(candidate) {
            youthForMixed.push(candidate);
            usedNames.add(candidate.Name);
          }
        }
      }
    } else {
      shuffle(allYouthPlayers);
      youthForMixed = assignWithoutCriteria(allYouthPlayers, numberOfMixedTeams, youthPerMixedTeam, usedNames);
    }
  }

  // preview-Teams zusammenbauen
  previewAdultTeams = [];
  for(let i=0; i<numberOfAdultTeams; i++){
    const startIdx = i*adultTeamSize;
    const endIdx   = (i+1)*adultTeamSize;
    previewAdultTeams.push(adultTeamPool.slice(startIdx, endIdx));
  }

  previewMixedTeams = [];
  for(let i=0; i<numberOfMixedTeams; i++){
    const adultSlice = adultsForMixed.slice(i*adultPerMixedTeam, (i+1)*adultPerMixedTeam);
    const youthSlice = youthForMixed.slice(i*youthPerMixedTeam, (i+1)*youthPerMixedTeam);
    const combined = [...adultSlice, ...youthSlice];
    previewMixedTeams.push(combined);
  }

  // unassigned
  const assignedAdultNames = [...adultTeamPool, ...adultsForMixed].map(p => p.Name);
  const assignedYouthNames = [...youthForMixed].map(p => p.Name);

  const unassignedAdults = allAdultPlayers.filter(p => !assignedAdultNames.includes(p.Name));
  const unassignedYouth = allYouthPlayers.filter(p => !assignedYouthNames.includes(p.Name));

  unassignedAdultsGlobal = unassignedAdults;
  unassignedYouthGlobal = unassignedYouth;

  showFeedbackModal(previewAdultTeams, previewMixedTeams);
  renderUnassignedPlayers(unassignedAdults, unassignedYouth);
  if(unassignedAdults.length>0 || unassignedYouth.length>0){
    unassignedPlayersSection.style.display = 'block';
  } else {
    unassignedPlayersSection.style.display = 'none';
  }

  applyPreviewButton.disabled = false;
});

function renderUnassignedPlayers(unassignedAdults, unassignedYouth){
  unassignedAdultsDiv.innerHTML = '';
  if(unassignedAdults.length>0){
    unassignedAdults.forEach(p=>{
      const div = document.createElement('div');
      div.className='player-item adult-player';
      div.textContent = `${p.Name} (${p.Spiele} Spiele)`;
      unassignedAdultsDiv.appendChild(div);
    });
  } else {
    unassignedAdultsDiv.innerHTML='<p>Keine nicht zugeteilten Erwachsenen.</p>';
  }

  unassignedYouthDiv.innerHTML = '';
  if(unassignedYouth.length>0){
    unassignedYouth.forEach(p=>{
      const div = document.createElement('div');
      div.className='player-item youth-player';
      div.textContent=`${p.Name} (${p.Spiele} Spiele)`;
      unassignedYouthDiv.appendChild(div);
    });
  } else {
    unassignedYouthDiv.innerHTML='<p>Keine nicht zugeteilten Jugendspieler.</p>';
  }
}

/* Anwenden der Vorschau */
applyPreviewButton.addEventListener('click', function() {
  adultTeams = JSON.parse(JSON.stringify(previewAdultTeams));
  mixedTeams = JSON.parse(JSON.stringify(previewMixedTeams));
  saveData();
  displayResults(adultTeams, mixedTeams);
  this.disabled = true;
});

/* ---------------------------------------------
   10) Ergebnisse anzeigen
--------------------------------------------- */
function displayResults(adultTeams, mixedTeams){
  resultsSection.style.display = 'block';

  adultTeamsListDiv.innerHTML = '';
  mixedTeamsListDiv.innerHTML = '';

  // Erwachsene Teams
  adultTeams.forEach((team, i)=>{
    const div = document.createElement('div');
    div.className='team-item';
    // Jeder Spieler wird farblich anhand isAdult / isYouth gekennzeichnet
    const names = team.map(p => wrapColoredPlayerName(p)).join(', ');
    div.innerHTML=`<strong>Erwachsenenteam ${i+1}:</strong> ${names}`;
    adultTeamsListDiv.appendChild(div);
  });

  // Mixed Teams
  mixedTeams.forEach((team, i)=>{
    const div = document.createElement('div');
    div.className='team-item';
    const names = team.map(p => wrapColoredPlayerName(p)).join(', ');
    div.innerHTML=`<strong>Team Jugend ${i+1}:</strong> ${names}`;
    mixedTeamsListDiv.appendChild(div);
  });

  createMatches(adultTeams, mixedTeams);
  updatePointsTable();
}

// Hilfsfunktion: Erzeugt <span class="adult-player">Name</span> oder <span class="youth-player">Name</span>
function wrapColoredPlayerName(player) {
  // Entscheiden, ob player zu adultPlayers oder youthPlayers gehört
  const isAdultPlayer = adultPlayers.some(ap => ap.Name === player.Name);
  const cssClass = isAdultPlayer ? 'adult-player' : 'youth-player';

  // Ggf. mehr Infos
  const displayName = formatPlayerForDisplay(player, /*detailed*/true, /*fullName*/true);
  return `<span class="${cssClass}">${displayName}</span>`;
}

// Name formatieren (für Team-Anzeige)
function formatPlayerForDisplay(player, showDetailed, showFullName){
  // showDetailed, showFullName sind hier auf "true" gesetzt in wrapColoredPlayerName,
  // du kannst sie anpassen, wenn du wieder Splits brauchst
  let displayName = player.Name;
  if(!showFullName){
    const parts = player.Name.split(' ');
    if(parts.length>1){
      displayName = parts[0]+' '+parts[1].charAt(0)+'.';
    } else {
      displayName = parts[0];
    }
  }
  if(showDetailed){
    // Falls Position bei Jugend leer ist, etc.
    const pos = player.Position ? `Pos: ${player.Position}, ` : '';
    const g = player.Geschlecht ? `G: ${player.Geschlecht}, ` : '';
    const l = player.Leitung ? `L: ${player.Leitung}` : '';
    return `${displayName} (${pos}${g}${l})`;
  } else {
    return displayName;
  }
}

/* ---------------------------------------------
   11) Matches
--------------------------------------------- */
function createMatches(adultTeams, mixedTeams){
  adultMatchesDiv.innerHTML='';
  mixedMatchesDiv.innerHTML='';

  // Erwachsene
  for(let i=0; i<adultTeams.length; i+=2){
    if(i+1<adultTeams.length){
      const matchDiv = document.createElement('div');
      matchDiv.className='match-item';
      matchDiv.innerHTML=`
        <strong>Feld ${Math.floor(i/2)+1}:</strong> 
        Erwachsenenteam ${i+1} gegen Erwachsenenteam ${i+2}
        <button class="button" data-match-type="adult" data-winning-team="${i}">
          Gewinner: Team ${i+1}
        </button>
        <button class="button" data-match-type="adult" data-winning-team="${i+1}">
          Gewinner: Team ${i+2}
        </button>
      `;
      adultMatchesDiv.appendChild(matchDiv);
    }
  }

  // Mixed
  for(let i=0; i<mixedTeams.length; i+=2){
    if(i+1<mixedTeams.length){
      const matchDiv = document.createElement('div');
      matchDiv.className='match-item';
      matchDiv.innerHTML=`
        <strong>Gemischtes Feld ${Math.floor(i/2)+1}:</strong> 
        Team Jugend ${i+1} gegen Team Jugend ${i+2}
        <button class="button" data-match-type="mixed" data-winning-team="${i}">
          Gewinner: Team ${i+1}
        </button>
        <button class="button" data-match-type="mixed" data-winning-team="${i+1}">
          Gewinner: Team ${i+2}
        </button>
      `;
      mixedMatchesDiv.appendChild(matchDiv);
    }
  }

  const buttons = document.querySelectorAll('.match-item .button');
  buttons.forEach(btn => {
    btn.addEventListener('click', function(){
      const matchType = this.getAttribute('data-match-type');
      const winningTeamIndex = parseInt(this.getAttribute('data-winning-team'));
      recordMatchResult(matchType, winningTeamIndex);
      this.parentNode.querySelectorAll('.button').forEach(b=>b.disabled=true);
    });
  });
}

function recordMatchResult(matchType, winningTeamIndex){
  let winningTeam=[], losingTeam=[];
  if(matchType==='adult'){
    winningTeam = adultTeams[winningTeamIndex];
    const oppIndex = (winningTeamIndex%2===0) ? winningTeamIndex+1 : winningTeamIndex-1;
    losingTeam = adultTeams[oppIndex];
  } else if(matchType==='mixed'){
    winningTeam = mixedTeams[winningTeamIndex];
    const oppIndex = (winningTeamIndex%2===0) ? winningTeamIndex+1 : winningTeamIndex-1;
    losingTeam = mixedTeams[oppIndex];
  } else {
    alert("Unbekannter Match-Typ");
    return;
  }

  // Punkte+Spiele
  winningTeam.forEach(p => {
    const pl = findPlayerByName(p.Name);
    if(pl){
      pl.Punkte+=1;
      pl.Spiele+=1;
    }
  });
  losingTeam.forEach(p=>{
    const pl = findPlayerByName(p.Name);
    if(pl){
      pl.Spiele+=1;
    }
  });

  alert(`${formatTeamName(matchType, winningTeamIndex)} hat gewonnen!`);
  updatePointsTable();
  saveData();
}

function formatTeamName(matchType, index){
  if(matchType==='adult'){
    return `Erwachsenenteam ${index+1}`;
  }
  return `Team Jugend ${index+1}`;
}

function findPlayerByName(name){
  let pl = adultPlayers.find(p=>p.Name===name);
  if(pl) return pl;
  pl = youthPlayers.find(p=>p.Name===name);
  return pl;
}

/* ---------------------------------------------
   12) Punkte-Tabelle + Farbliche Kennzeichnung
--------------------------------------------- */
function updatePointsTable(){
  pointsTableBody.innerHTML='';

  // Erwachsene
  adultPlayers.forEach((p, i)=>{
    const tr = document.createElement('tr');
    // Hintergrund adult-player
    tr.classList.add('adult-player');

    tr.innerHTML=`
      <td>${p.Name}</td>
      <td>${p.Spiele}</td>
      <td>${p.Punkte}</td>
      <td>
        <button class="adjust-button" onclick="adjustPoints('adult', ${i}, 1)">+Punkt</button>
        <button class="adjust-button" onclick="adjustPoints('adult', ${i}, -1)">-Punkt</button>
        <button class="adjust-button" onclick="adjustGames('adult', ${i}, 1)">+Spiel</button>
        <button class="adjust-button" onclick="adjustGames('adult', ${i}, -1)">-Spiel</button>
      </td>
    `;
    pointsTableBody.appendChild(tr);
  });

  // Jugend
  youthPlayers.forEach((p, i)=>{
    const tr = document.createElement('tr');
    // Hintergrund youth-player
    tr.classList.add('youth-player');

    tr.innerHTML=`
      <td>${p.Name}</td>
      <td>${p.Spiele}</td>
      <td>${p.Punkte}</td>
      <td>
        <button class="adjust-button" onclick="adjustPoints('youth', ${i}, 1)">+Punkt</button>
        <button class="adjust-button" onclick="adjustPoints('youth', ${i}, -1)">-Punkt</button>
        <button class="adjust-button" onclick="adjustGames('youth', ${i}, 1)">+Spiel</button>
        <button class="adjust-button" onclick="adjustGames('youth', ${i}, -1)">-Spiel</button>
      </td>
    `;
    pointsTableBody.appendChild(tr);
  });
}

window.adjustPoints = function(type, index, delta){
  if(type==='adult'){
    const p=adultPlayers[index];
    if(delta<0 && p.Punkte<=0){
      alert("Punkte können nicht negativ werden!");
      return;
    }
    p.Punkte+=delta;
  } else {
    const p=youthPlayers[index];
    if(delta<0 && p.Punkte<=0){
      alert("Punkte können nicht negativ werden!");
      return;
    }
    p.Punkte+=delta;
  }
  updatePointsTable();
  saveData();
};

window.adjustGames = function(type, index, delta){
  if(type==='adult'){
    const p=adultPlayers[index];
    if(delta<0 && p.Spiele<=0){
      alert("Spiele können nicht negativ werden!");
      return;
    }
    p.Spiele+=delta;
  } else {
    const p=youthPlayers[index];
    if(delta<0 && p.Spiele<=0){
      alert("Spiele können nicht negativ werden!");
      return;
    }
    p.Spiele+=delta;
  }
  updatePointsTable();
  saveData();
};

/* ---------------------------------------------
   13) Modal / CSV
--------------------------------------------- */
function showFeedbackModal(aTeams, mTeams){
  const modal = document.getElementById('feedbackModal');
  const span = document.getElementsByClassName('close')[0];
  const feedbackContent = document.getElementById('feedbackContent');

  let html = `<h3>Erwachsenenteams (Vorschau):</h3>`;
  aTeams.forEach((team, idx)=>{
    const names=team.map(p=>p.Name).join(', ');
    html+=`<p><strong>Team ${idx+1}:</strong> ${names}</p>`;
  });
  html+=`<h3>Gemischte Teams (Vorschau):</h3>`;
  mTeams.forEach((team, idx)=>{
    const names=team.map(p=>p.Name).join(', ');
    html+=`<p><strong>Team Jugend ${idx+1}:</strong> ${names}</p>`;
  });

  feedbackContent.innerHTML=html;
  modal.style.display='block';

  span.onclick=()=>modal.style.display='none';
  window.onclick=(e)=>{
    if(e.target===modal) modal.style.display='none';
  };
}

exportButton.addEventListener('click', ()=>{
  const csvContent = generateCSV();
  downloadCSV(csvContent, 'spielergebnisse.csv');
});

function generateCSV(){
  let csv='Name,Spiele,Punkte\n';
  adultPlayers.forEach(p=>{
    csv+=`"${p.Name}",${p.Spiele},${p.Punkte}\n`;
  });
  youthPlayers.forEach(p=>{
    csv+=`"${p.Name}",${p.Spiele},${p.Punkte}\n`;
  });
  return csv;
}
function downloadCSV(csvContent, filename){
  const blob=new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
  if(navigator.msSaveBlob){
    navigator.msSaveBlob(blob, filename);
  } else {
    const link=document.createElement('a');
    if(link.download!==undefined){
      const url=URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility='hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  }
}

/* ---------------------------------------------
   14) onload
--------------------------------------------- */
window.onload=function(){
  loadData();
  renderPlayerList();
  updatePointsTable();
  if(adultTeams.length>0||mixedTeams.length>0){
    displayResults(adultTeams,mixedTeams);
  }
};
</script>

</body>
</html>
